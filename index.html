<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✨ Smart Expiry Tracker Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --urgent-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            --warning-gradient: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            --good-gradient: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            --info-gradient: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
            --dark-gradient: linear-gradient(135deg, #141e30 0%, #243b55 100%);
            --light-bg: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-sm: 12px;
            --radius-md: 18px;
            --radius-lg: 28px;
            --radius-xl: 36px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--light-bg);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 15px;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(255, 65, 108, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(102, 126, 234, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 50% 50%, rgba(86, 171, 47, 0.03) 0%, transparent 30%);
            z-index: -1;
            pointer-events: none;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            animation: fadeIn 0.6s ease-out;
            position: relative;
            z-index: 1;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-gradient);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            animation: welcomeFadeIn 0.8s ease-out;
        }
        
        @keyframes welcomeFadeIn {
            from { opacity: 0; backdrop-filter: blur(0px); }
            to { opacity: 1; backdrop-filter: blur(10px); }
        }
        
        .welcome-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 60px 50px;
            border-radius: var(--radius-xl);
            text-align: center;
            width: 100%;
            max-width: 600px;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            animation: slideUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .welcome-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                from 0deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent 30%
            );
            animation: rotate 4s linear infinite;
            z-index: 0;
        }
        
        .welcome-container > * {
            position: relative;
            z-index: 1;
        }
        
        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        .welcome-icon {
            width: 120px;
            height: 120px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.5);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3); }
            50% { transform: scale(1.1); box-shadow: 0 20px 40px rgba(102, 126, 234, 0.5); }
            100% { transform: scale(1); box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3); }
        }
        
        .welcome-container h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 36px;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .welcome-container p {
            margin-bottom: 30px;
            color: var(--text-secondary);
            font-size: 18px;
            line-height: 1.6;
        }
        
        .welcome-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 30px 0;
        }
        
        .welcome-feature {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 15px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .welcome-feature i {
            color: #667eea;
            font-size: 18px;
        }
        
        /* Fixed Modal Styles - Now Scrollable */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1002;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .modal.active {
            display: flex;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        .modal-container {
            background: white;
            border-radius: var(--radius-xl);
            text-align: center;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            animation: slideUp 0.3s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .modal-content {
            padding: 40px 35px;
            overflow-y: auto;
            flex: 1;
            text-align: left;
        }
        
        .modal-footer {
            padding: 25px 35px;
            background: linear-gradient(135deg, #f8fafc, #edf2f7);
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .modal-footer button {
            flex: 1;
            min-width: 200px;
            padding: 18px;
        }
        
        .modal-scrollable {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        /* Scrollbar styling for modal */
        .modal-scrollable::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-scrollable::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .modal-scrollable::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        
        .modal-scrollable::-webkit-scrollbar-thumb:hover {
            background: #5a6fd9;
        }
        
        .toast {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            color: var(--text-primary);
            padding: 25px 40px;
            border-radius: var(--radius-lg);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.2);
            z-index: 1003;
            display: none;
            align-items: center;
            gap: 20px;
            font-weight: 700;
            max-width: 90%;
            animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .toast.active {
            display: flex;
        }
        
        .toast-error {
            background: linear-gradient(135deg, rgba(255, 65, 108, 0.95), rgba(255, 75, 43, 0.95));
            color: white;
        }
        
        .toast-warning {
            background: linear-gradient(135deg, rgba(247, 151, 30, 0.95), rgba(255, 210, 0, 0.95));
            color: white;
        }
        
        .toast-success {
            background: linear-gradient(135deg, rgba(86, 171, 47, 0.95), rgba(168, 224, 99, 0.95));
            color: white;
        }
        
        .toast-info {
            background: linear-gradient(135deg, rgba(54, 209, 220, 0.95), rgba(91, 134, 229, 0.95));
            color: white;
        }
        
        .toast-urgent {
            background: linear-gradient(135deg, rgba(255, 65, 108, 0.95), rgba(255, 75, 43, 0.95));
            color: white;
            animation: toastPulse 2s infinite;
        }
        
        @keyframes toastPulse {
            0% { box-shadow: 0 20px 40px rgba(255, 65, 108, 0.3); }
            50% { box-shadow: 0 25px 50px rgba(255, 65, 108, 0.5); }
            100% { box-shadow: 0 20px 40px rgba(255, 65, 108, 0.3); }
        }
        
        .sound-alert-indicator {
            position: fixed;
            top: 30px;
            right: 30px;
            background: var(--urgent-gradient);
            color: white;
            padding: 20px 30px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 999;
            display: none;
            align-items: center;
            gap: 20px;
            animation: slideInRight 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: indicatorPulse 3s infinite;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .sound-alert-indicator.active {
            display: flex;
        }
        
        @keyframes indicatorPulse {
            0% { 
                box-shadow: 0 20px 40px rgba(255, 65, 108, 0.3);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 25px 50px rgba(255, 65, 108, 0.5);
                transform: scale(1.05);
            }
            100% { 
                box-shadow: 0 20px 40px rgba(255, 65, 108, 0.3);
                transform: scale(1);
            }
        }
        
        header {
            background: var(--primary-gradient);
            color: white;
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: 
                linear-gradient(90deg, 
                    transparent, 
                    rgba(255, 255, 255, 0.2), 
                    transparent),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            transform: translateX(-100%);
            animation: shimmer 3s infinite;
            z-index: 1;
        }
        
        @keyframes shimmer {
            100% { transform: translateX(100%); }
        }
        
        header > * {
            position: relative;
            z-index: 2;
        }
        
        @media (min-width: 768px) {
            header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 35px 50px;
            }
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo i {
            font-size: 42px;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 50%;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite;
        }
        
        .logo h1 {
            font-size: 32px;
            font-weight: 800;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, white, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @media (min-width: 768px) {
            .logo h1 {
                font-size: 36px;
            }
        }
        
        .header-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        
        @media (min-width: 768px) {
            .header-controls {
                flex-wrap: nowrap;
                justify-content: flex-end;
            }
        }
        
        .item-count {
            background: rgba(255, 255, 255, 0.25);
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 800;
            font-size: 17px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .item-count:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-2px);
        }
        
        nav {
            background: rgba(255, 255, 255, 0.95);
            padding: 0 20px;
            border-bottom: 1px solid rgba(226, 232, 240, 0.5);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
        }
        
        @media (min-width: 768px) {
            nav {
                padding: 0 40px;
                justify-content: flex-start;
                flex-wrap: nowrap;
                overflow-x: auto;
                scrollbar-width: none;
            }
            
            nav::-webkit-scrollbar {
                display: none;
            }
        }
        
        .nav-btn {
            padding: 22px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 160px;
            justify-content: center;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .nav-btn:hover {
            color: var(--text-primary);
        }
        
        .nav-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }
        
        .nav-btn i {
            font-size: 20px;
        }
        
        .content {
            padding: 30px 25px;
            min-height: 600px;
        }
        
        @media (min-width: 768px) {
            .content {
                padding: 45px 40px;
            }
        }
        
        .section-header {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-bottom: 35px;
            padding-bottom: 30px;
            border-bottom: 2px solid rgba(226, 232, 240, 0.8);
            position: relative;
        }
        
        .section-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100px;
            height: 4px;
            background: var(--primary-gradient);
            border-radius: 2px;
        }
        
        @media (min-width: 768px) {
            .section-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .section-header h2 {
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 18px;
            font-size: 28px;
            font-weight: 700;
        }
        
        @media (min-width: 768px) {
            .section-header h2 {
                font-size: 32px;
            }
        }
        
        .section-header h2 i {
            background: var(--primary-gradient);
            color: white;
            padding: 15px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
        }
        
        .bubble-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        @media (min-width: 640px) {
            .bubble-container {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
        }
        
        @media (min-width: 1200px) {
            .bubble-container {
                grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            }
        }
        
        .expiry-bubble {
            padding: 35px;
            border-radius: var(--radius-lg);
            color: white;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .expiry-bubble:hover {
            transform: translateY(-10px);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(255, 255, 255, 0.2);
        }
        
        .expiry-bubble::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.1) 100%
            );
            z-index: 1;
        }
        
        .expiry-bubble > * {
            position: relative;
            z-index: 2;
        }
        
        .expiry-bubble.urgent {
            background: var(--urgent-gradient) !important;
            animation: urgentPulse 3s infinite;
        }
        
        @keyframes urgentPulse {
            0% { box-shadow: 0 20px 40px rgba(255, 65, 108, 0.3); }
            50% { box-shadow: 0 25px 50px rgba(255, 65, 108, 0.5); }
            100% { box-shadow: 0 20px 40px rgba(255, 65, 108, 0.3); }
        }
        
        .expiry-bubble.warning {
            background: var(--warning-gradient);
        }
        
        .expiry-bubble.good {
            background: var(--good-gradient);
        }
        
        .expiry-bubble.category-beverages {
            background: linear-gradient(135deg, #00b4d8 0%, #0077b6 100%);
        }
        
        .expiry-bubble.category-confectionery {
            background: linear-gradient(135deg, #ff9e00 0%, #ff5e00 100%);
        }
        
        .expiry-bubble.category-grocery {
            background: linear-gradient(135deg, #56ab2f 0%, #2d8f1d 100%);
        }
        
        .expiry-bubble.category-icecream {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
        }
        
        .expiry-bubble.category-snacks {
            background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
        }
        
        .expiry-bubble.category-other {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
        }
        
        .bubble-header {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
            z-index: 10;
        }
        
        @media (min-width: 480px) {
            .bubble-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-start;
            }
        }
        
        .barcode {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            letter-spacing: 1.5px;
            font-size: 16px;
            word-break: break-all;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 70%;
            z-index: 10;
        }
        
        .expiry-date {
            font-weight: 800;
            font-size: 17px;
            background: rgba(0, 0, 0, 0.4);
            padding: 12px 24px;
            border-radius: 50px;
            white-space: nowrap;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(10px);
            z-index: 10;
            position: relative;
            z-index: 5;
        }
        
        .product-description {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 25px;
            line-height: 1.4;
            word-break: break-word;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            letter-spacing: -0.5px;
            position: relative;
            z-index: 10;
            padding-right: 100px;
        }
        
        .product-quantity {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            position: relative;
            z-index: 10;
        }
        
        .days-left {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.5);
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 800;
            font-size: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-md);
            z-index: 10;
        }
        
        .urgent-badge {
            position: absolute;
            top: 30px;
            right: 30px;
            background: linear-gradient(135deg, #ff3838 0%, #ff1e1e 100%);
            color: white;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 14px;
            box-shadow: 
                0 10px 30px rgba(255, 56, 56, 0.5),
                0 0 0 3px rgba(255, 255, 255, 0.3);
            animation: badgePulse 2s infinite;
            z-index: 5;
            border: 2px solid rgba(255, 255, 255, 0.5);
            overflow: hidden;
            text-align: center;
            padding: 10px;
            line-height: 1.2;
            z-index: 20;
        }
        
        .urgent-badge::before {
            content: '';
            position: absolute;
            width: 150%;
            height: 150%;
            background: conic-gradient(
                transparent,
                rgba(255, 255, 255, 0.5),
                transparent 30%
            );
            animation: rotate 3s linear infinite;
        }
        
        .urgent-badge span {
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes badgePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .category-badge {
            display: none;
        }
        
        .notes-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-top: 25px;
            border: 2px dashed #e2e8f0;
            box-shadow: var(--shadow-sm);
        }
        
        .notes-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .notes-header h4 {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 700;
        }
        
        .notes-textarea {
            width: 100%;
            min-height: 120px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: var(--radius-md);
            font-size: 16px;
            resize: vertical;
            background: white;
            color: var(--text-primary);
            transition: all 0.3s;
        }
        
        .notes-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .notes-display {
            background: linear-gradient(135deg, #f8fafc, #edf2f7);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 15px;
            min-height: 60px;
            border-left: 4px solid #667eea;
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        .statistics-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--primary-gradient);
        }
        
        .stat-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-value {
            font-size: 42px;
            font-weight: 900;
            color: #667eea;
            margin: 20px 0;
            text-shadow: 0 2px 10px rgba(102, 126, 234, 0.2);
        }
        
        .stat-label {
            font-size: 15px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 600;
        }
        
        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 30px;
            -webkit-overflow-scrolling: touch;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(226, 232, 240, 0.5);
            background: white;
            position: relative;
        }
        
        .product-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1000px;
            background: white;
        }
        
        .product-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: left;
            padding: 22px 25px;
            font-weight: 700;
            font-size: 16px;
            position: sticky;
            top: 0;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            white-space: nowrap;
            letter-spacing: 0.5px;
        }
        
        .product-table th:first-child {
            border-top-left-radius: var(--radius-lg);
            padding-left: 30px;
        }
        
        .product-table th:last-child {
            border-top-right-radius: var(--radius-lg);
            padding-right: 30px;
        }
        
        .product-table td {
            padding: 22px 25px;
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            font-size: 16px;
            position: relative;
            cursor: pointer;
        }
        
        .product-table td:first-child {
            padding-left: 30px;
            border-left: 3px solid transparent;
        }
        
        .product-table tr:hover td {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
        }
        
        .product-table tr:hover td:first-child {
            border-left-color: #667eea;
        }
        
        .status-badge {
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 800;
            display: inline-block;
            box-shadow: var(--shadow-md);
            min-width: 100px;
            text-align: center;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
        }
        
        .status-expired {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
            animation: expiredPulse 2s infinite;
        }
        
        @keyframes expiredPulse {
            0% { box-shadow: 0 5px 20px rgba(255, 65, 108, 0.3); }
            50% { box-shadow: 0 8px 25px rgba(255, 65, 108, 0.5); }
            100% { box-shadow: 0 5px 20px rgba(255, 65, 108, 0.3); }
        }
        
        .status-warning {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            color: white;
        }
        
        .status-good {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }
        
        .status-urgent {
            background: linear-gradient(135deg, #ff3838 0%, #ff1e1e 100%);
            color: white;
            animation: badgePulse 2s infinite;
        }
        
        .action-btn {
            background: linear-gradient(135deg, #f8fafc, #edf2f7);
            border: 1px solid #e2e8f0;
            cursor: pointer;
            font-size: 22px;
            color: #64748b;
            padding: 14px;
            border-radius: var(--radius-md);
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            z-index: 100;
        }
        
        .action-btn:hover {
            color: #ff416c;
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border-color: #ff416c;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            appearance: none;
            -webkit-appearance: none;
            background: white;
        }
        
        input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }
        
        input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 14px;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 30px;
            color: #64748b;
            position: relative;
        }
        
        .empty-state h3 {
            font-size: 30px;
            margin-bottom: 20px;
            color: #94a3b8;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }
        
        .btn {
            padding: 20px 35px;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-sm {
            padding: 14px 25px;
            font-size: 16px;
            border-radius: var(--radius-md);
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd9 0%, #6a489c 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #ff2b5e 0%, #ff3b1a 100%);
        }
        
        .btn-warning {
            background: var(--warning-gradient);
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #f68e1e 0%, #ffc800 100%);
        }
        
        .btn-info {
            background: var(--info-gradient);
            color: white;
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #26c1dc 0%, #4a76e5 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #4d9c2a 0%, #98d059 100%);
        }
        
        .form-group {
            margin-bottom: 30px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
        }
        
        .form-control {
            width: 100%;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: var(--radius-md);
            font-size: 18px;
            background: white;
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 
                0 0 0 5px rgba(102, 126, 234, 0.15),
                var(--shadow-sm);
            outline: none;
            transform: translateY(-2px);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        @media (min-width: 640px) {
            .form-row {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .optional-badge {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e0);
            color: #718096;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .collapsible-section {
            background: white;
            border-radius: var(--radius-lg);
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid #e2e8f0;
        }
        
        .collapsible-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, #f8fafc, #edf2f7);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid transparent;
        }
        
        .collapsible-header:hover {
            background: linear-gradient(135deg, #edf2f7, #e2e8f0);
        }
        
        .collapsible-header h4 {
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 18px;
            font-weight: 700;
        }
        
        .collapsible-header i {
            transition: transform 0.3s;
        }
        
        .collapsible-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .collapsible-content.active {
            padding: 30px;
            max-height: 2000px;
        }
        
        .additional-fields {
            background: white;
            padding: 30px;
            border-radius: var(--radius-lg);
            margin-top: 30px;
            box-shadow: var(--shadow-md);
            border: 2px dashed #e2e8f0;
            background: linear-gradient(135deg, #f8fafc, #ffffff);
        }
        
        .additional-fields-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .custom-field-group {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .custom-field-group {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        .remove-field-btn {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: var(--shadow-sm);
        }
        
        .remove-field-btn:hover {
            background: linear-gradient(135deg, #ff2b5e, #ff3b1a);
            transform: scale(1.1);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 80px;
            height: 40px;
            flex-shrink: 0;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #cbd5e0, #94a3b8);
            border-radius: 34px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 32px;
            width: 32px;
            left: 4px;
            bottom: 4px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 2;
        }
        
        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #56ab2f, #a8e063);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(40px);
        }
        
        .alert-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 2px solid white;
            z-index: 10;
            animation: badgePulse 2s infinite;
        }
        
        .batch-actions {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 25px;
            background: linear-gradient(135deg, #f8fafc, #edf2f7);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid #e2e8f0;
        }
        
        .select-all-checkbox {
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 700;
            color: var(--text-primary);
            padding: 12px 20px;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }
        
        @media (max-width: 767px) {
            .container {
                border-radius: var(--radius-lg);
            }
            
            .expiry-bubble {
                padding: 25px;
            }
            
            .product-description {
                font-size: 24px;
                padding-right: 80px;
            }
            
            .sound-alert-indicator {
                top: 20px;
                right: 20px;
                left: 20px;
                justify-content: space-between;
                padding: 15px 20px;
            }
            
            .urgent-badge {
                width: 60px;
                height: 60px;
                font-size: 12px;
                top: 20px;
                right: 20px;
            }
            
            .modal-container {
                max-width: 95%;
                max-height: 85vh;
            }
            
            .modal-content {
                padding: 25px 20px;
            }
            
            .modal-footer {
                padding: 20px;
                flex-direction: column;
            }
            
            .modal-footer button {
                min-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .header-controls {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-sm {
                width: 100%;
            }
            
            .nav-btn {
                min-width: 140px;
                padding: 18px 15px;
                font-size: 14px;
            }
            
            .nav-btn i {
                font-size: 18px;
            }
            
            .expiry-bubble {
                padding: 20px;
            }
            
            .product-description {
                font-size: 22px;
                padding-right: 70px;
            }
            
            .urgent-badge {
                width: 50px;
                height: 50px;
                font-size: 10px;
                top: 15px;
                right: 15px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .section-header h2 {
                font-size: 24px;
            }
            
            .section-header h2 i {
                width: 50px;
                height: 50px;
                padding: 12px;
                font-size: 20px;
            }
            
            .modal-content {
                padding: 20px 15px;
            }
        }
        
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            animation: fabPulse 2s infinite;
            transition: all 0.3s ease;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
        }
        
        @keyframes fabPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        #printBtn {
            bottom: 110px;
            background: var(--warning-gradient);
        }
        
        audio {
            display: none !important;
            visibility: hidden !important;
            position: absolute !important;
            width: 0 !important;
            height: 0 !important;
        }
        
        .product-table td:last-child {
            position: relative;
            z-index: 100;
        }
        
        .action-btn-container {
            display: flex;
            gap: 10px;
            position: relative;
            z-index: 100;
        }
        
        .expiry-bubble .bubble-header {
            margin-top: 10px;
        }
        
        .product-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .detail-item {
            background: white;
            padding: 20px;
            border-radius: var(--radius-md);
            border: 1px solid #e2e8f0;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .detail-value {
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .custom-field-display {
            background: white;
            padding: 15px;
            border-radius: var(--radius-sm);
            border: 1px solid #e2e8f0;
            margin-bottom: 10px;
        }
        
        .custom-field-key {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .custom-field-value {
            color: var(--text-secondary);
        }

        /* Custom sound upload section */
        .custom-sound-section {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f8fafc, #edf2f7);
            border-radius: var(--radius-lg);
            border: 2px dashed #cbd5e0;
        }

        .sound-upload-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .sound-preview {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: var(--radius-md);
            border: 1px solid #e2e8f0;
        }

        .sound-upload-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .sound-upload-btn:hover {
            background: linear-gradient(135deg, #5a6fd9, #6a489c);
            transform: translateY(-2px);
        }

        .sound-upload-btn input {
            display: none;
        }
        
        /* JSON Upload Section */
        .json-upload-section {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f8fafc, #edf2f7);
            border-radius: var(--radius-lg);
            border: 2px dashed #cbd5e0;
        }
        
        .json-upload-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #56ab2f, #a8e063);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .json-upload-btn:hover {
            background: linear-gradient(135deg, #4d9c2a, #98d059);
            transform: translateY(-2px);
        }
        
        .json-upload-btn input {
            display: none;
        }
        
        .json-preview {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: var(--radius-md);
            border: 1px solid #e2e8f0;
        }
        
        .mappings-count {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        /* Base64 upload indicator */
        .base64-indicator {
            background: linear-gradient(135deg, #ff9e00, #ff5e00);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="welcome-container">
            <div class="welcome-icon">
                <i class="fas fa-clock" style="font-size: 60px; color: white;"></i>
            </div>
            <h2>✨ Smart Expiry Tracker Pro</h2>
            <p>Advanced inventory management with real-time alerts and beautiful visual interface</p>
            
            <div class="welcome-features">
                <div class="welcome-feature">
                    <i class="fas fa-bell"></i>
                    <span>Immediate Sound Alerts</span>
                </div>
                <div class="welcome-feature">
                    <i class="fas fa-palette"></i>
                    <span>Visual Color Coding</span>
                </div>
                <div class="welcome-feature">
                    <i class="fas fa-edit"></i>
                    <span>Notes System</span>
                </div>
                <div class="welcome-feature">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Import/Export Data</span>
                </div>
                <div class="welcome-feature">
                    <i class="fas fa-keyboard"></i>
                    <span>Keyboard Shortcuts</span>
                </div>
                <div class="welcome-feature">
                    <i class="fas fa-mobile-alt"></i>
                    <span>Mobile Friendly</span>
                </div>
            </div>
            
            <button class="btn btn-primary" id="startSystem" style="margin-top: 30px; width: 100%; padding: 22px;">
                <i class="fas fa-rocket"></i> Launch System
            </button>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-container">
            <div class="modal-content">
                <div style="
                    width: 100px;
                    height: 100px;
                    background: linear-gradient(135deg, #ff416c, #ff4b2b);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 25px;
                    box-shadow: 0 15px 35px rgba(255, 65, 108, 0.3);
                    border: 3px solid rgba(255, 255, 255, 0.5);
                ">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: white;"></i>
                </div>
                <h2 style="color: #ff416c; font-size: 28px; text-align: center;">Confirm Deletion</h2>
                <p id="deleteMessage" style="margin: 25px 0; font-size: 18px; line-height: 1.6; text-align: center;">
                    Are you sure you want to delete this item?
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="confirmDelete">
                    <i class="fas fa-trash-alt"></i> Delete Item
                </button>
                <button class="btn btn-primary" id="cancelDelete">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div id="productDetailsModal" class="modal">
        <div class="modal-container">
            <div class="modal-content" id="productDetailsContent">
                <!-- Product details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="editProductBtn">
                    <i class="fas fa-edit"></i> Edit Product
                </button>
                <button class="btn btn-danger" id="deleteProductBtn">
                    <i class="fas fa-trash-alt"></i> Delete Product
                </button>
                <button class="btn" id="closeDetailsBtn">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Operation completed successfully!</span>
    </div>

    <!-- Sound Alert Indicator -->
    <div id="soundAlertIndicator" class="sound-alert-indicator">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="
                width: 50px;
                height: 50px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 2px solid rgba(255, 255, 255, 0.3);
            ">
                <i class="fas fa-bell" style="font-size: 24px; color: white;"></i>
            </div>
            <div>
                <div id="alertCountText" style="font-weight: 700; font-size: 16px;">0 items expiring soon!</div>
                <div style="font-size: 14px; opacity: 0.9;">Click to acknowledge</div>
            </div>
        </div>
        <button class="btn btn-sm" onclick="acknowledgeAlerts()" style="
            color: white; 
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px;
            min-width: 40px;
            border-radius: 12px;
        ">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Main Container -->
    <div class="container" id="mainContainer" style="display: none;">
        <!-- Header -->
        <header>
            <div class="logo">
                <i class="fas fa-clock"></i>
                <div>
                    <h1>✨ Smart Expiry Tracker Pro</h1>
                    <p style="opacity: 0.9; font-size: 16px; margin-top: 5px;">Advanced Inventory Management with Real-Time Alerts & Visual Analytics</p>
                </div>
            </div>
            <div class="header-controls">
                <div class="item-count">
                    <i class="fas fa-boxes"></i> <span id="totalItems">0</span> Items
                </div>
                <div class="item-count" style="background: rgba(255, 65, 108, 0.25);">
                    <i class="fas fa-exclamation-triangle"></i> <span id="urgentCount">0</span> Urgent
                </div>
                <button class="btn btn-warning btn-sm" id="exportBtn" title="Ctrl+E to Export">
                    <i class="fas fa-download"></i> Export
                </button>
                <button class="btn btn-info btn-sm" id="importBtn" title="Ctrl+I to Import">
                    <i class="fas fa-upload"></i> Import
                </button>
            </div>
        </header>
        
        <!-- Navigation -->
        <nav>
            <button class="nav-btn active" data-section="expiring">
                <i class="fas fa-exclamation-triangle"></i> Expiring Soon
                <span class="alert-count" id="navUrgentCount" style="display: none;">0</span>
            </button>
            <button class="nav-btn" data-section="expired">
                <i class="fas fa-calendar-times"></i> Expired Items
                <span class="alert-count" id="navExpiredCount" style="display: none;">0</span>
            </button>
            <button class="nav-btn" data-section="add">
                <i class="fas fa-plus-circle"></i> Add Product
            </button>
            <button class="nav-btn" data-section="all">
                <i class="fas fa-list"></i> All Products
            </button>
            <button class="nav-btn" data-section="alerts">
                <i class="fas fa-bell"></i> Alert Settings
            </button>
            <button class="nav-btn" data-section="instructions">
                <i class="fas fa-info-circle"></i> Guide
            </button>
        </nav>
        
        <!-- Main Content -->
        <div class="content">
            <!-- Expiring Soon Section -->
            <section id="expiringSection" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-exclamation-triangle"></i> Items Expiring Soon (Next 10 Days)</h2>
                    <div class="item-count">
                        <i class="fas fa-clock"></i> <span id="expiringCount">0</span> Items
                    </div>
                </div>
                
                <!-- Quick Stats Cards -->
                <div class="statistics-panel" style="margin-bottom: 40px;">
                    <div class="stat-card">
                        <i class="fas fa-fire" style="font-size: 24px; color: #ff416c;"></i>
                        <div class="stat-value" id="urgentStat">0</div>
                        <div class="stat-label">Urgent (0-3 days)</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-exclamation" style="font-size: 24px; color: #f7971e;"></i>
                        <div class="stat-value" id="warningStat">0</div>
                        <div class="stat-label">Warning (4-7 days)</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check" style="font-size: 24px; color: #56ab2f;"></i>
                        <div class="stat-value" id="goodStat">0</div>
                        <div class="stat-label">Good (8-10 days)</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-layer-group" style="font-size: 24px; color: #667eea;"></i>
                        <div class="stat-value" id="categoryStat">0</div>
                        <div class="stat-label">Categories</div>
                    </div>
                </div>
                
                <div id="expiringBubbles" class="bubble-container">
                    <!-- Expiring items will appear here as colorful bubbles -->
                </div>
                <div id="noExpiringItems" class="empty-state" style="display: none;">
                    <div style="width: 120px; height: 120px; background: linear-gradient(135deg, #e2e8f0, #cbd5e0); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 30px;">
                        <i class="fas fa-check-circle" style="font-size: 60px; color: #94a3b8;"></i>
                    </div>
                    <h3>No Items Expiring Soon</h3>
                    <p style="max-width: 400px;">All products are safely within their expiry dates.</p>
                </div>
            </section>

            <!-- Expired Items Section -->
            <section id="expiredSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-times"></i> Expired Items</h2>
                    <div class="item-count" style="background: rgba(255, 65, 108, 0.25);">
                        <i class="fas fa-exclamation-circle"></i> <span id="expiredCount">0</span> Items
                    </div>
                </div>
                
                <!-- Notes for Expired Items -->
                <div class="notes-section">
                    <div class="notes-header">
                        <i class="fas fa-edit" style="color: #667eea; font-size: 24px;"></i>
                        <h4>Notes for Expired Products</h4>
                    </div>
                    <textarea class="notes-textarea" id="expiredNotes" placeholder="Add notes about expired products (e.g., disposal method, reasons, follow-up actions)..."></textarea>
                    <div class="notes-display" id="expiredNotesDisplay">
                        No notes added yet.
                    </div>
                </div>
                
                <!-- Bulk Actions -->
                <div class="batch-actions">
                    <div class="select-all-checkbox">
                        <input type="checkbox" id="selectAllExpired" onchange="toggleSelectAllExpired()">
                        <label for="selectAllExpired">Select All</label>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="bulkDeleteSelected()" id="bulkDeleteBtn">
                        <i class="fas fa-trash"></i> Delete Selected (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportExpiredOnly()">
                        <i class="fas fa-download"></i> Export Expired List
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="product-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="headerCheckbox" onchange="toggleAllCheckboxes()">
                                </th>
                                <th>Barcode</th>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Category</th>
                                <th>Expiry Date</th>
                                <th>Days Expired</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="expiredTableBody">
                            <!-- Expired items will appear here -->
                        </tbody>
                    </table>
                </div>
                <div id="noExpiredItems" class="empty-state" style="display: none;">
                    <div style="width: 120px; height: 120px; background: linear-gradient(135deg, #e2e8f0, #cbd5e0); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 30px;">
                        <i class="fas fa-check-circle" style="font-size: 60px; color: #94a3b8;"></i>
                    </div>
                    <h3>No Expired Items</h3>
                    <p style="max-width: 400px;">Excellent! All products are within their expiry dates.</p>
                </div>
            </section>
            
            <!-- Add Product Section -->
            <section id="addSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-plus-circle"></i> Add New Product</h2>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 14px; color: var(--text-secondary); background: linear-gradient(135deg, #f8fafc, #edf2f7); padding: 8px 16px; border-radius: 20px;">
                            <i class="fas fa-keyboard"></i> Press <kbd>Ctrl + S</kbd> to Save
                        </div>
                        <button class="btn btn-sm btn-info" onclick="generateRandomProduct()">
                            <i class="fas fa-random"></i> Quick Fill
                        </button>
                    </div>
                </div>
                
                <!-- ENHANCED: JSON/Base64 File Upload Section - SIMPLIFIED -->
                <div class="json-upload-section">
                    <div class="sound-upload-container">
                        <label class="json-upload-btn">
                            <i class="fas fa-upload"></i> Upload file
                            <input type="file" id="jsonUploadInput" accept=".json,.txt" style="display: none;">
                        </label>
                        
                        <div id="jsonPreview" class="json-preview" style="display: none;">
                            <i class="fas fa-file-json" style="color: #56ab2f; font-size: 24px;"></i>
                            <div>
                                <div id="jsonFileName" style="font-weight: 600;"></div>
                                <div id="jsonFileSize" style="font-size: 12px; color: var(--text-secondary);"></div>
                                <div id="jsonFileType" style="font-size: 11px; color: #667eea; font-weight: 600;"></div>
                            </div>
                            <div style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                                <div class="mappings-count" id="mappingsCount">0 mappings</div>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeJsonFile()">
                                    <i class="fas fa-times"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="add-form">
                    <form id="addProductForm">
                        <!-- Required Fields Section -->
                        <div class="collapsible-section" style="border-left: 4px solid #667eea;">
                            <div class="collapsible-header">
                                <h4><i class="fas fa-asterisk" style="color: #ff416c;"></i> Required Information</h4>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="collapsible-content active">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="barcode"><i class="fas fa-barcode"></i> Barcode</label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="text" id="barcode" class="form-control" placeholder="Enter barcode or product code" required>
                                            <button type="button" class="btn btn-sm btn-info" onclick="generateBarcode()" style="white-space: nowrap;">
                                                <i class="fas fa-random"></i> Generate
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="description"><i class="fas fa-tag"></i> Product Description</label>
                                        <input type="text" id="description" class="form-control" placeholder="Enter product name or description" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="expiryDate"><i class="fas fa-calendar-alt"></i> Expiry Date</label>
                                        <input type="date" id="expiryDate" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="quantity"><i class="fas fa-cubes"></i> Quantity *</label>
                                        <input type="number" id="quantity" class="form-control" min="1" placeholder="Enter quantity" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="category"><i class="fas fa-layer-group"></i> Category</label>
                                        <div class="category-options" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                                            <button type="button" class="category-option" data-category="Beverages and Dairy">
                                                <i class="fas fa-wine-bottle"></i> Beverages & Dairy
                                            </button>
                                            <button type="button" class="category-option" data-category="Confectionery">
                                                <i class="fas fa-candy-cane"></i> Confectionery
                                            </button>
                                            <button type="button" class="category-option" data-category="Grocery">
                                                <i class="fas fa-shopping-basket"></i> Grocery
                                            </button>
                                            <button type="button" class="category-option" data-category="Ice Cream">
                                                <i class="fas fa-ice-cream"></i> Ice Cream
                                            </button>
                                            <button type="button" class="category-option" data-category="Snacks">
                                                <i class="fas fa-cookie-bite"></i> Snacks
                                            </button>
                                            <button type="button" class="category-option" data-category="Other">
                                                <i class="fas fa-box"></i> Other
                                            </button>
                                        </div>
                                        <input type="text" id="category" class="form-control" style="margin-top: 15px;" placeholder="Or enter custom category" value="Beverages and Dairy">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes Section for Added Products -->
                        <div class="collapsible-section">
                            <div class="collapsible-header">
                                <h4><i class="fas fa-edit"></i> Product Notes</h4>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="collapsible-content">
                                <div class="notes-section">
                                    <div class="notes-header">
                                        <i class="fas fa-sticky-note" style="color: #667eea; font-size: 24px;"></i>
                                        <h4>Add Notes for This Product</h4>
                                    </div>
                                    <textarea class="notes-textarea" id="productNotes" placeholder="Add notes about this product (e.g., storage instructions, special handling, batch details)..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Custom Fields Section -->
                        <div class="collapsible-section">
                            <div class="collapsible-header">
                                <h4><i class="fas fa-plus-square"></i> Additional Information</h4>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="collapsible-content">
                                <div class="additional-fields">
                                    <div class="additional-fields-header">
                                        <div>
                                            <h3><i class="fas fa-info-circle"></i> Extra Details</h3>
                                            <p style="font-size: 14px; color: var(--text-secondary); margin-top: 5px;">
                                                Add any extra details like storage conditions, batch details, etc.
                                            </p>
                                        </div>
                                        <button type="button" class="btn btn-info" id="addCustomField">
                                            <i class="fas fa-plus"></i> Add Field
                                        </button>
                                    </div>
                                    <div id="customFieldsContainer">
                                        <!-- Custom fields will be added here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="form-group" style="margin-top: 40px;">
                            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 22px; font-size: 20px;">
                                <i class="fas fa-save"></i> Save Product
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- All Products Section -->
            <section id="allSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-list"></i> All Products</h2>
                    <div class="item-count">
                        <i class="fas fa-boxes"></i> <span id="allProductsCount">0</span> Items
                    </div>
                </div>
                
                <!-- Advanced Search and Filter Bar -->
                <div style="
                    background: white;
                    padding: 25px;
                    border-radius: var(--radius-lg);
                    margin-bottom: 30px;
                    display: flex;
                    flex-wrap: wrap;
                    gap: 20px;
                    align-items: center;
                ">
                    <div style="flex: 1; min-width: 300px;">
                        <div style="position: relative;">
                            <i class="fas fa-search" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #94a3b8;"></i>
                            <input type="text" id="searchProducts" class="form-control" placeholder="Search products by name, barcode, category..." style="padding-left: 50px;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <select id="filterCategory" class="form-control" style="min-width: 200px;">
                            <option value="">All Categories</option>
                            <option value="Beverages and Dairy">Beverages & Dairy</option>
                            <option value="Confectionery">Confectionery</option>
                            <option value="Grocery">Grocery</option>
                            <option value="Ice Cream">Ice Cream</option>
                            <option value="Snacks">Snacks</option>
                            <option value="Other">Other</option>
                        </select>
                        
                        <select id="filterStatus" class="form-control" style="min-width: 200px;">
                            <option value="">All Status</option>
                            <option value="urgent">Urgent (0-3 days)</option>
                            <option value="warning">Warning (4-7 days)</option>
                            <option value="good">Good (8-10 days)</option>
                            <option value="expired">Expired</option>
                        </select>
                        
                        <select id="filterSort" class="form-control" style="min-width: 180px;">
                            <option value="expiry-asc">Sort: Expiry (Closest)</option>
                            <option value="expiry-desc">Sort: Expiry (Farthest)</option>
                            <option value="name-asc">Sort: Name (A-Z)</option>
                            <option value="name-desc">Sort: Name (Z-A)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="statistics-panel" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <i class="fas fa-clock" style="font-size: 24px; color: #667eea;"></i>
                        <div class="stat-value" id="totalStat">0</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-fire" style="font-size: 24px; color: #ff416c;"></i>
                        <div class="stat-value" id="allUrgentStat">0</div>
                        <div class="stat-label">Urgent Items</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-calendar-times" style="font-size: 24px; color: #ff416c;"></i>
                        <div class="stat-value" id="allExpiredStat">0</div>
                        <div class="stat-label">Expired Items</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-calendar-check" style="font-size: 24px; color: #56ab2f;"></i>
                        <div class="stat-value" id="safeStat">0</div>
                        <div class="stat-label">Safe Items</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="product-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="selectAllHeader" onchange="toggleSelectAllProducts()">
                                </th>
                                <th>Barcode</th>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Category</th>
                                <th>Expiry Date</th>
                                <th>Days Left</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allProductsTableBody">
                            <!-- All products will appear here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="noProducts" class="empty-state" style="display: none;">
                    <div style="width: 120px; height: 120px; background: linear-gradient(135deg, #e2e8f0, #cbd5e0); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 30px;">
                        <i class="fas fa-box-open" style="font-size: 60px; color: #94a3b8;"></i>
                    </div>
                    <h3>No Products Added Yet</h3>
                    <p style="max-width: 400px;">Start by adding your first product using the "Add Product" section.</p>
                    <button class="btn btn-primary" onclick="switchSection('add')" style="margin-top: 20px;">
                        <i class="fas fa-plus-circle"></i> Add First Product
                    </button>
                </div>
                
                <!-- Bulk Actions Panel -->
                <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #f8fafc, #edf2f7); border-radius: var(--radius-lg);">
                    <h4 style="margin-bottom: 20px;"><i class="fas fa-tasks"></i> Bulk Operations</h4>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-sm btn-danger" onclick="bulkDeleteSelectedProducts()">
                            <i class="fas fa-trash"></i> Delete Selected Items (<span id="selectedProductsCount">0</span>)
                        </button>
                        <button class="btn btn-sm btn-success" onclick="exportData()">
                            <i class="fas fa-download"></i> Export All Data
                        </button>
                        <button class="btn btn-sm btn-info" onclick="document.getElementById('importFileInput').click()">
                            <i class="fas fa-upload"></i> Import Data
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="bulkDeleteExpired()">
                            <i class="fas fa-trash-alt"></i> Delete All Expired
                        </button>
                        <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importData(event)">
                    </div>
                </div>
            </section>

            <!-- Alert Settings Section -->
            <section id="alertsSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-bell"></i> Smart Alert Settings</h2>
                    <div class="item-count">
                        <i class="fas fa-cog"></i> Configuration
                    </div>
                </div>
                
                <div class="alert-settings" style="
                    background: white;
                    padding: 40px;
                    border-radius: var(--radius-xl);
                    margin-top: 30px;
                    max-width: 800px;
                    box-shadow: var(--shadow-lg);
                    border: 1px solid rgba(226, 232, 240, 0.5);
                    position: relative;
                    overflow: hidden;
                ">
                    <!-- Immediate Alert Settings -->
                    <div style="margin-bottom: 40px;">
                        <h3><i class="fas fa-bolt"></i> Immediate Alerts</h3>
                        <p style="font-size: 15px; color: var(--text-secondary); margin-top: 5px;">
                            Configure automatic alerts when urgent items are detected
                        </p>
                        
                        <div class="settings-row" style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 35px; padding: 25px; background: linear-gradient(135deg, #f8fafc, #edf2f7); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0;">
                            <div>
                                <strong>Play Sound on Page Load</strong>
                                <p style="font-size: 15px; color: var(--text-secondary); margin-top: 5px;">
                                    Automatically play alert sound when urgent items (0-3 days) are found on page load
                                </p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="immediateAlertToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="settings-row" style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 35px; padding: 25px; background: linear-gradient(135deg, #f8fafc, #edf2f7); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0;">
                            <div>
                                <strong>Continuous Alerts Until Acknowledged</strong>
                                <p style="font-size: 15px; color: var(--text-secondary); margin-top: 5px;">
                                    Keep playing alert sound every 5 minutes until acknowledged
                                </p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="continuousAlertToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Alert Customization -->
                    <div style="margin-bottom: 40px;">
                        <h3><i class="fas fa-sliders-h"></i> Alert Customization</h3>
                        
                        <div class="settings-row" style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 35px; padding: 25px; background: linear-gradient(135deg, #f8fafc, #edf2f7); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0;">
                            <div>
                                <strong>Alert Sound Volume</strong>
                                <p style="font-size: 15px; color: var(--text-secondary); margin-top: 5px;">
                                    Adjust the volume of the alert sound
                                </p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <input type="range" id="alertVolume" min="0" max="100" value="80" style="width: 200px;">
                                <span id="volumeValue" style="font-weight: 600; color: #667eea;">80%</span>
                            </div>
                        </div>
                        
                        <div class="settings-row" style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 35px; padding: 25px; background: linear-gradient(135deg, #f8fafc, #edf2f7); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0;">
                            <div>
                                <strong>Alert Frequency</strong>
                                <p style="font-size: 15px; color: var(--text-secondary); margin-top: 5px;">
                                    How often to repeat alerts for urgent items
                                </p>
                            </div>
                            <select id="alertFrequency" class="form-control" style="width: 200px;">
                                <option value="once">Once only</option>
                                <option value="5min" selected>Every 5 minutes</option>
                                <option value="15min">Every 15 minutes</option>
                                <option value="30min">Every 30 minutes</option>
                                <option value="hourly">Every hour</option>
                            </select>
                        </div>

                        <!-- Custom Sound Upload -->
                        <div class="settings-row" style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 35px; padding: 25px; background: linear-gradient(135deg, #f8fafc, #edf2f7); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0;">
                            <div>
                                <strong><i class="fas fa-music"></i> Custom Alert Sound</strong>
                                <p style="font-size: 15px; color: var(--text-secondary); margin-top: 5px;">
                                    Upload a custom sound file for alerts (MP3, WAV, OGG)
                                </p>
                            </div>
                            <div class="custom-sound-section">
                                <div class="sound-upload-container">
                                    <label class="sound-upload-btn">
                                        <i class="fas fa-upload"></i> Choose Sound File
                                        <input type="file" id="customSoundInput" accept=".mp3,.wav,.ogg" style="display: none;">
                                    </label>
                                    <div id="soundPreview" class="sound-preview" style="display: none;">
                                        <i class="fas fa-music" style="color: #667eea; font-size: 24px;"></i>
                                        <div>
                                            <div id="soundFileName" style="font-weight: 600;"></div>
                                            <div id="soundFileSize" style="font-size: 12px; color: var(--text-secondary);"></div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-danger" onclick="removeCustomSound()" style="margin-left: auto;">
                                            <i class="fas fa-times"></i> Remove
                                        </button>
                                        <button type="button" class="btn btn-sm btn-info" onclick="testCustomSound()">
                                            <i class="fas fa-play"></i> Test
                                        </button>
                                    </div>
                                    <small style="color: var(--text-secondary); font-size: 12px;">
                                        Max file size: 5MB. Supported formats: MP3, WAV, OGG
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alert Thresholds -->
                    <div style="margin-top: 40px; padding: 30px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05)); border-radius: var(--radius-lg);">
                        <h4><i class="fas fa-tachometer-alt"></i> Alert Thresholds</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-top: 20px;">
                            <div>
                                <label style="font-weight: 600; margin-bottom: 10px; display: block;">Urgent Alert (Days)</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="urgentThreshold" min="1" max="7" value="3" style="flex: 1;">
                                    <span id="urgentThresholdValue" style="font-weight: 700; color: #ff416c; min-width: 40px;">3</span>
                                </div>
                                <small style="display: block; margin-top: 8px; color: #94a3b8;">
                                    Items expiring within <span id="urgentDays">3</span> days trigger urgent alerts
                                </small>
                            </div>
                            
                            <div>
                                <label style="font-weight: 600; margin-bottom: 10px; display: block;">Warning Alert (Days)</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="warningThreshold" min="4" max="14" value="7" style="flex: 1;">
                                    <span id="warningThresholdValue" style="font-weight: 700; color: #f7971e; min-width: 40px;">7</span>
                                </div>
                                <small style="display: block; margin-top: 8px; color: #94a3b8;">
                                    Items expiring within <span id="warningDays">7</span> days show warning
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alert Control Buttons -->
                    <div style="margin-top: 40px; display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-danger" id="testAlertBtn">
                            <i class="fas fa-volume-up"></i> Test Urgent Alert
                        </button>
                        <button class="btn btn-success" id="acknowledgeAllBtn">
                            <i class="fas fa-check-circle"></i> Acknowledge All Alerts
                        </button>
                        <button class="btn btn-info" id="saveAlertSettings">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </section>

            <!-- Instructions/Guide Section -->
            <section id="instructionsSection" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-info-circle"></i> System Guide & Best Practices</h2>
                    <div class="item-count">
                        <i class="fas fa-book"></i> Documentation
                    </div>
                </div>
                
                <!-- Quick Start Guide -->
                <div style="
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    padding: 40px;
                    border-radius: var(--radius-xl);
                    margin-bottom: 40px;
                    position: relative;
                    overflow: hidden;
                ">
                    <div style="position: absolute; top: 0; right: 0; width: 200px; height: 200px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; transform: translate(50%, -50%);"></div>
                    <div style="position: absolute; bottom: 0; left: 0; width: 150px; height: 150px; background: rgba(255, 255, 255, 0.05); border-radius: 50%; transform: translate(-50%, 50%);"></div>
                    
                    <div style="position: relative; z-index: 2;">
                        <h3 style="font-size: 32px; margin-bottom: 15px;">🚀 Quick Start Guide</h3>
                        <p style="font-size: 18px; opacity: 0.9; margin-bottom: 30px; max-width: 800px;">
                            Get started with Smart Expiry Tracker Pro in 3 simple steps
                        </p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-top: 30px;">
                            <div style="background: rgba(255, 255, 255, 0.2); padding: 25px; border-radius: var(--radius-lg); backdrop-filter: blur(10px);">
                                <div style="
                                    width: 60px;
                                    height: 60px;
                                    background: white;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    margin-bottom: 20px;
                                    font-size: 24px;
                                    font-weight: 900;
                                    color: #667eea;
                                ">1</div>
                                <h4 style="font-size: 20px; margin-bottom: 10px;">Add Products</h4>
                                <p style="opacity: 0.9; font-size: 15px;">
                                    Add your products with barcode, description, expiry date, quantity, and optional notes
                                </p>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.2); padding: 25px; border-radius: var(--radius-lg); backdrop-filter: blur(10px);">
                                <div style="
                                    width: 60px;
                                    height: 60px;
                                    background: white;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    margin-bottom: 20px;
                                    font-size: 24px;
                                    font-weight: 900;
                                    color: #667eea;
                                ">2</div>
                                <h4 style="font-size: 20px; margin-bottom: 10px;">Set Up Alerts</h4>
                                <p style="opacity: 0.9; font-size: 15px;">
                                    Configure automatic alerts for products expiring soon
                                </p>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.2); padding: 25px; border-radius: var(--radius-lg); backdrop-filter: blur(10px);">
                                <div style="
                                    width: 60px;
                                    height: 60px;
                                    background: white;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    margin-bottom: 20px;
                                    font-size: 24px;
                                    font-weight: 900;
                                    color: #667eea;
                                ">3</div>
                                <h4 style="font-size: 20px; margin-bottom: 10px;">Monitor & Export</h4>
                                <p style="opacity: 0.9; font-size: 15px;">
                                    Monitor your inventory and export data for reporting
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Feature Cards Grid -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: var(--text-primary); margin-bottom: 25px; display: flex; align-items: center; gap: 15px;">
                        <i class="fas fa-star" style="color: #f7971e;"></i>
                        Core Features
                    </h3>
                    
                    <div class="instruction-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                        
                        <!-- Visual Alerts Card -->
                        <div class="instruction-card" style="
                            background: white;
                            padding: 30px;
                            border-radius: var(--radius-lg);
                            box-shadow: var(--shadow-md);
                            border-top: 5px solid #ff416c;
                        ">
                            <div style="
                                width: 70px;
                                height: 70px;
                                background: linear-gradient(135deg, #ff416c, #ff4b2b);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin-bottom: 20px;
                            ">
                                <i class="fas fa-bell" style="font-size: 30px; color: white;"></i>
                            </div>
                            <h3 style="color: var(--text-primary); margin-bottom: 15px; font-size: 20px;">Immediate Sound Alerts</h3>
                            <p style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                                Automatic sound alerts play immediately when items with 0-3 days expiry are detected. Alerts continue until acknowledged.
                            </p>
                        </div>
                        
                        <!-- Notes System -->
                        <div class="instruction-card" style="
                            background: white;
                            padding: 30px;
                            border-radius: var(--radius-lg);
                            box-shadow: var(--shadow-md);
                            border-top: 5px solid #56ab2f;
                        ">
                            <div style="
                                width: 70px;
                                height: 70px;
                                background: linear-gradient(135deg, #56ab2f, #a8e063);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin-bottom: 20px;
                            ">
                                <i class="fas fa-edit" style="font-size: 30px; color: white;"></i>
                            </div>
                            <h3 style="color: var(--text-primary); margin-bottom: 15px; font-size: 20px;">Notes System</h3>
                            <p style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                                Add notes for added products and expired items. Track important information and follow-up actions.
                            </p>
                        </div>
                        
                        <!-- Import/Export -->
                        <div class="instruction-card" style="
                            background: white;
                            padding: 30px;
                            border-radius: var(--radius-lg);
                            box-shadow: var(--shadow-md);
                            border-top: 5px solid #36d1dc;
                        ">
                            <div style="
                                width: 70px;
                                height: 70px;
                                background: linear-gradient(135deg, #36d1dc, #5b86e5);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin-bottom: 20px;
                            ">
                                <i class="fas fa-exchange-alt" style="font-size: 30px; color: white;"></i>
                            </div>
                            <h3 style="color: var(--text-primary); margin-bottom: 15px; font-size: 20px;">Import & Export</h3>
                            <p style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                                Full data backup/restore capabilities. Import from JSON or Base64-encoded files. Export to JSON, CSV. Never lose your data.
                            </p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Audio Elements for Sounds -->
    <audio id="saveSound" preload="auto" style="display: none;"></audio>
    <audio id="deleteSound" preload="auto" style="display: none;"></audio>
    <audio id="alertSound" preload="auto" style="display: none;"></audio>
    <audio id="notificationSound" preload="auto" style="display: none;"></audio>
    <audio id="clickSound" preload="auto" style="display: none;"></audio>

    <!-- Hidden Import File Input -->
    <input type="file" id="csvImportFile" accept=".csv" style="display: none;">

    <!-- Floating Action Button -->
    <button class="fab" id="quickAddBtn" title="Quick Add (Q)">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Print Button -->
    <button class="fab" id="printBtn" title="Print (P)" style="bottom: 100px; background: var(--warning-gradient);">
        <i class="fas fa-print"></i>
    </button>

    <!-- Footer -->
    <footer style="
        background: var(--dark-gradient);
        color: white;
        text-align: center;
        padding: 40px 20px;
        margin-top: 60px;
        position: relative;
        overflow: hidden;
    ">
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--primary-gradient);"></div>
        
        <div style="max-width: 800px; margin: 0 auto;">
            <div style="
                width: 80px;
                height: 80px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 25px;
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
                border: 3px solid rgba(255, 255, 255, 0.3);
            ">
                <i class="fas fa-clock" style="font-size: 36px; color: white;"></i>
            </div>
            
            <p style="font-size: 18px; font-weight: 600;">✨ Smart Expiry Tracker Pro &copy; <span id="currentYear"></span></p>
            <p style="margin-top: 10px; font-size: 15px; opacity: 0.9;">Advanced Inventory Management with 100% Reliable Sound Alerts</p>
            
            <!-- Creator Signature -->
            <div style="
                margin-top: 30px;
                padding: 25px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: var(--radius-lg);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                max-width: 500px;
                margin-left: auto;
                margin-right: auto;
            ">
                <div class="signature" style="
                    margin-top: 0;
                    font-style: italic;
                    font-size: 20px;
                    color: #fbbf24;
                    line-height: 1.6;
                    font-weight: 700;
                    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                ">
                    Shandana 💔 Nasrullah
                </div>
                <small style="
                    font-size: 14px;
                    opacity: 0.8;
                    display: block;
                    margin-top: 10px;
                    max-width: 400px;
                    margin-left: auto;
                    margin-right: auto;
                ">
                    I live through you; if I fall, your soul falls with me
                </small>
            </div>
            
            <!-- Quick Links -->
            <div style="
                margin-top: 30px;
                display: flex;
                justify-content: center;
                gap: 20px;
                flex-wrap: wrap;
            ">
                <a href="javascript:void(0)" onclick="exportData()" style="
                    color: white;
                    text-decoration: none;
                    padding: 10px 20px;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    transition: all 0.3s;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                ">
                    <i class="fas fa-download"></i> Export Data
                </a>
                <a href="javascript:void(0)" onclick="switchSection('instructions')" style="
                    color: white;
                    text-decoration: none;
                    padding: 10px 20px;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    transition: all 0.3s;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                ">
                    <i class="fas fa-question-circle"></i> Guide
                </a>
                <a href="javascript:void(0)" onclick="switchSection('alerts')" style="
                    color: white;
                    text-decoration: none;
                    padding: 10px 20px;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    transition: all 0.3s;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                ">
                    <i class="fas fa-bell"></i> Alert Settings
                </a>
                <a href="javascript:void(0)" onclick="testUrgentAlert()" style="
                    color: white;
                    text-decoration: none;
                    padding: 10px 20px;
                    background: rgba(255, 65, 108, 0.3);
                    border-radius: 8px;
                    transition: all 0.3s;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                ">
                    <i class="fas fa-volume-up"></i> Test Alert
                </a>
            </div>
            
            <!-- System Status -->
            <div style="
                margin-top: 30px;
                padding: 20px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: var(--radius-md);
                font-size: 14px;
                opacity: 0.8;
            ">
                <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;">
                    <div>
                        <i class="fas fa-boxes"></i> 
                        <span id="footerTotalItems">0</span> Products
                    </div>
                    <div>
                        <i class="fas fa-fire"></i> 
                        <span id="footerUrgentItems">0</span> Urgent
                    </div>
                    <div>
                        <i class="fas fa-clock"></i> 
                        <span id="footerExpiringItems">0</span> Expiring Soon
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // ======================
        // MAIN APPLICATION SCRIPT - ENHANCED VERSION WITH BASE64 SUPPORT
        // ======================

        // Core Application State
        const AppState = {
            products: [],
            filteredProducts: [],
            currentSection: 'expiring',
            customSound: null,
            customSoundURL: null,
            barcodeMappings: {}, // Store barcode-to-description mappings
            alertHistory: [],
            settings: {
                immediateAlert: true,
                continuousAlert: true,
                desktopNotifications: false,
                alertVolume: 80,
                alertFrequency: '5min',
                urgentThreshold: 3,
                warningThreshold: 7,
                checkFrequency: 60,
                useCustomSound: false
            },
            selectedProducts: [],
            selectedExpired: [],
            startupTime: new Date(),
            alertsToday: 0,
            alertInterval: null,
            acknowledgedAlerts: false,
            alertTimeout: null,
            notes: {
                expired: '',
                addedProducts: []
            },
            currentProductToDelete: null,
            currentProductToView: null,
            lastUploadType: null // 'json' or 'base64'
        };

        // Initialize Audio
        const audioElements = {
            save: new Audio(),
            delete: new Audio(),
            alert: new Audio(),
            notification: new Audio(),
            click: new Audio(),
            custom: new Audio()
        };

        // DOM Elements
        const elements = {};

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeElements();
            initializeEventListeners();
            loadFromLocalStorage();
            initializeWelcomeScreen();
            updateCurrentYear();
            
            // Initialize sound effects
            initializeSoundEffects();
            
            // Set initial volume
            updateAlertVolume(80);
            
            // Initialize alert system
            setTimeout(() => {
                checkForUrgentItems();
            }, 1000);
        });

        // Initialize DOM element references
        function initializeElements() {
            // Main sections
            elements.mainContainer = document.getElementById('mainContainer');
            elements.welcomeScreen = document.getElementById('welcomeScreen');
            elements.startSystem = document.getElementById('startSystem');
            
            // Toast and modals
            elements.toast = document.getElementById('toast');
            elements.toastMessage = document.getElementById('toastMessage');
            elements.deleteModal = document.getElementById('deleteModal');
            elements.deleteMessage = document.getElementById('deleteMessage');
            elements.confirmDelete = document.getElementById('confirmDelete');
            elements.cancelDelete = document.getElementById('cancelDelete');
            
            // Product details modal
            elements.productDetailsModal = document.getElementById('productDetailsModal');
            elements.productDetailsContent = document.getElementById('productDetailsContent');
            elements.editProductBtn = document.getElementById('editProductBtn');
            elements.deleteProductBtn = document.getElementById('deleteProductBtn');
            elements.closeDetailsBtn = document.getElementById('closeDetailsBtn');
            
            // Alert indicator
            elements.soundAlertIndicator = document.getElementById('soundAlertIndicator');
            elements.alertCountText = document.getElementById('alertCountText');
            
            // Navigation
            elements.navBtns = document.querySelectorAll('.nav-btn');
            
            // Sections
            elements.sections = {
                expiring: document.getElementById('expiringSection'),
                expired: document.getElementById('expiredSection'),
                add: document.getElementById('addSection'),
                all: document.getElementById('allSection'),
                alerts: document.getElementById('alertsSection'),
                instructions: document.getElementById('instructionsSection')
            };
            
            // Count elements
            elements.totalItems = document.getElementById('totalItems');
            elements.urgentCount = document.getElementById('urgentCount');
            elements.navUrgentCount = document.getElementById('navUrgentCount');
            elements.navExpiredCount = document.getElementById('navExpiredCount');
            elements.expiringCount = document.getElementById('expiringCount');
            elements.expiredCount = document.getElementById('expiredCount');
            elements.allProductsCount = document.getElementById('allProductsCount');
            
            // Statistics
            elements.urgentStat = document.getElementById('urgentStat');
            elements.warningStat = document.getElementById('warningStat');
            elements.goodStat = document.getElementById('goodStat');
            elements.categoryStat = document.getElementById('categoryStat');
            
            // Form elements
            elements.addProductForm = document.getElementById('addProductForm');
            elements.barcode = document.getElementById('barcode');
            elements.description = document.getElementById('description');
            elements.expiryDate = document.getElementById('expiryDate');
            elements.category = document.getElementById('category');
            elements.quantity = document.getElementById('quantity');
            
            // Notes elements
            elements.productNotes = document.getElementById('productNotes');
            elements.expiredNotes = document.getElementById('expiredNotes');
            elements.expiredNotesDisplay = document.getElementById('expiredNotesDisplay');
            
            // Bubble container
            elements.expiringBubbles = document.getElementById('expiringBubbles');
            elements.noExpiringItems = document.getElementById('noExpiringItems');
            elements.noExpiredItems = document.getElementById('noExpiredItems');
            elements.noProducts = document.getElementById('noProducts');
            
            // Tables
            elements.expiredTableBody = document.getElementById('expiredTableBody');
            elements.allProductsTableBody = document.getElementById('allProductsTableBody');
            
            // Search and filter
            elements.searchProducts = document.getElementById('searchProducts');
            elements.filterCategory = document.getElementById('filterCategory');
            elements.filterStatus = document.getElementById('filterStatus');
            elements.filterSort = document.getElementById('filterSort');
            
            // Alert settings
            elements.immediateAlertToggle = document.getElementById('immediateAlertToggle');
            elements.continuousAlertToggle = document.getElementById('continuousAlertToggle');
            elements.alertVolume = document.getElementById('alertVolume');
            elements.volumeValue = document.getElementById('volumeValue');
            elements.alertFrequency = document.getElementById('alertFrequency');
            
            // Custom sound elements
            elements.customSoundInput = document.getElementById('customSoundInput');
            elements.soundPreview = document.getElementById('soundPreview');
            elements.soundFileName = document.getElementById('soundFileName');
            elements.soundFileSize = document.getElementById('soundFileSize');
            
            // ENHANCED: JSON/Base64 upload elements - SIMPLIFIED
            elements.jsonUploadInput = document.getElementById('jsonUploadInput');
            elements.jsonPreview = document.getElementById('jsonPreview');
            elements.jsonFileName = document.getElementById('jsonFileName');
            elements.jsonFileSize = document.getElementById('jsonFileSize');
            elements.jsonFileType = document.getElementById('jsonFileType');
            elements.mappingsCount = document.getElementById('mappingsCount');
            
            // Thresholds
            elements.urgentThreshold = document.getElementById('urgentThreshold');
            elements.urgentThresholdValue = document.getElementById('urgentThresholdValue');
            elements.urgentDays = document.getElementById('urgentDays');
            elements.warningThreshold = document.getElementById('warningThreshold');
            elements.warningThresholdValue = document.getElementById('warningThresholdValue');
            elements.warningDays = document.getElementById('warningDays');
            
            // Buttons
            elements.testAlertBtn = document.getElementById('testAlertBtn');
            elements.acknowledgeAllBtn = document.getElementById('acknowledgeAllBtn');
            elements.saveAlertSettings = document.getElementById('saveAlertSettings');
            elements.exportBtn = document.getElementById('exportBtn');
            elements.importBtn = document.getElementById('importBtn');
            elements.quickAddBtn = document.getElementById('quickAddBtn');
            elements.printBtn = document.getElementById('printBtn');
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Welcome screen
            elements.startSystem.addEventListener('click', launchSystem);
            
            // Navigation
            elements.navBtns.forEach(btn => {
                btn.addEventListener('click', () => switchSection(btn.dataset.section));
            });
            
            // Delete modal
            elements.confirmDelete.addEventListener('click', confirmDeletion);
            elements.cancelDelete.addEventListener('click', hideDeleteModal);
            
            // Product details modal
            elements.editProductBtn.addEventListener('click', function() {
                if (AppState.currentProductToView) {
                    editProduct(AppState.currentProductToView);
                    hideProductDetailsModal();
                }
            });
            
            elements.deleteProductBtn.addEventListener('click', function() {
                if (AppState.currentProductToView) {
                    const product = AppState.products.find(p => p.id === AppState.currentProductToView);
                    if (product) {
                        showDeleteModal(product.id, product.description);
                        hideProductDetailsModal();
                    }
                }
            });
            
            elements.closeDetailsBtn.addEventListener('click', hideProductDetailsModal);
            
            // Form submission
            elements.addProductForm.addEventListener('submit', addProduct);
            
            // Category selection
            document.querySelectorAll('.category-option').forEach(option => {
                option.addEventListener('click', function() {
                    elements.category.value = this.dataset.category;
                    playClickSound();
                });
            });
            
            // Collapsible sections
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const icon = this.querySelector('i');
                    
                    if (content.classList.contains('active')) {
                        content.classList.remove('active');
                        icon.className = 'fas fa-chevron-down';
                    } else {
                        content.classList.add('active');
                        icon.className = 'fas fa-chevron-up';
                    }
                    playClickSound();
                });
            });
            
            // Barcode input event listener for auto-fill
            if (elements.barcode) {
                elements.barcode.addEventListener('input', function() {
                    autoFillDescriptionFromBarcode(this.value);
                });
                elements.barcode.addEventListener('change', function() {
                    autoFillDescriptionFromBarcode(this.value);
                });
            }
            
            // ENHANCED: JSON/Base64 upload event listener
            if (elements.jsonUploadInput) {
                elements.jsonUploadInput.addEventListener('change', handleJsonUpload);
            }
            
            // Search and filter
            elements.searchProducts.addEventListener('input', filterProducts);
            elements.filterCategory.addEventListener('change', filterProducts);
            elements.filterStatus.addEventListener('change', filterProducts);
            elements.filterSort.addEventListener('change', filterProducts);
            
            // Alert settings
            if (elements.immediateAlertToggle) elements.immediateAlertToggle.addEventListener('change', updateAlertSetting);
            if (elements.continuousAlertToggle) elements.continuousAlertToggle.addEventListener('change', updateAlertSetting);
            
            if (elements.alertVolume) {
                elements.alertVolume.addEventListener('input', function() {
                    const value = this.value;
                    elements.volumeValue.textContent = `${value}%`;
                    updateAlertVolume(value);
                });
            }
            
            if (elements.alertFrequency) elements.alertFrequency.addEventListener('change', updateAlertSetting);
            
            // Custom sound upload
            if (elements.customSoundInput) {
                elements.customSoundInput.addEventListener('change', handleCustomSoundUpload);
            }
            
            // Threshold sliders
            if (elements.urgentThreshold) {
                elements.urgentThreshold.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    elements.urgentThresholdValue.textContent = value;
                    elements.urgentDays.textContent = value;
                    AppState.settings.urgentThreshold = value;
                    updateAllDisplays();
                });
            }
            
            if (elements.warningThreshold) {
                elements.warningThreshold.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    elements.warningThresholdValue.textContent = value;
                    elements.warningDays.textContent = value;
                    AppState.settings.warningThreshold = value;
                    updateAllDisplays();
                });
            }
            
            // Expired notes
            if (elements.expiredNotes) {
                elements.expiredNotes.addEventListener('input', function() {
                    AppState.notes.expired = this.value;
                    saveToLocalStorage();
                });
            }
            
            // Alert control buttons
            if (elements.testAlertBtn) elements.testAlertBtn.addEventListener('click', testUrgentAlert);
            if (elements.acknowledgeAllBtn) elements.acknowledgeAllBtn.addEventListener('click', acknowledgeAlerts);
            if (elements.saveAlertSettings) elements.saveAlertSettings.addEventListener('click', saveAlertSettings);
            
            // Export/Import buttons
            if (elements.exportBtn) elements.exportBtn.addEventListener('click', exportData);
            if (elements.importBtn) {
                elements.importBtn.addEventListener('click', function() {
                    const importInput = document.getElementById('importFileInput');
                    if (importInput) importInput.click();
                });
            }
            
            // Quick add button
            if (elements.quickAddBtn) elements.quickAddBtn.addEventListener('click', function() {
                switchSection('add');
                playClickSound();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // Print button
            if (elements.printBtn) elements.printBtn.addEventListener('click', printData);
            
            // Custom field addition
            const addCustomFieldBtn = document.getElementById('addCustomField');
            if (addCustomFieldBtn) addCustomFieldBtn.addEventListener('click', addCustomField);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            // Window events
            window.addEventListener('beforeunload', saveToLocalStorage);
        }

        // ======================
        // ENHANCED JSON/BASE64 UPLOAD FEATURE
        // ======================

        // Check if a string is Base64 encoded
        function isBase64(str) {
            try {
                // Check if it starts with data URL prefix
                if (str.startsWith('data:application/json;base64,')) {
                    return true;
                }
                
                // Check if it's valid Base64 (excluding data URL)
                const base64Regex = /^[A-Za-z0-9+/]*={0,2}$/;
                if (!base64Regex.test(str)) {
                    return false;
                }
                
                // Try to decode
                const decoded = atob(str);
                // Check if decoded result is valid UTF-8
                return decodeURIComponent(escape(decoded)) !== '';
            } catch (e) {
                return false;
            }
        }

        // Extract Base64 from data URL
        function extractBase64FromDataURL(dataURL) {
            if (dataURL.startsWith('data:application/json;base64,')) {
                return dataURL.replace('data:application/json;base64,', '');
            }
            return dataURL;
        }

        // Detect and decode Base64 content
        function detectAndDecodeBase64(content) {
            try {
                // Trim whitespace
                const trimmedContent = content.trim();
                
                // Check if it's a data URL
                if (trimmedContent.startsWith('data:')) {
                    const base64Data = extractBase64FromDataURL(trimmedContent);
                    const decoded = atob(base64Data);
                    return {
                        type: 'base64',
                        content: decoded,
                        wasDataURL: true
                    };
                }
                
                // Check if it's regular Base64
                if (isBase64(trimmedContent)) {
                    const decoded = atob(trimmedContent);
                    return {
                        type: 'base64',
                        content: decoded,
                        wasDataURL: false
                    };
                }
                
                // Not Base64, assume it's regular JSON
                return {
                    type: 'json',
                    content: trimmedContent,
                    wasDataURL: false
                };
            } catch (error) {
                throw new Error('Failed to decode Base64: ' + error.message);
            }
        }

        // Handle JSON/Base64 file upload
        function handleJsonUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validExtensions = ['.json', '.txt'];
            const fileName = file.name.toLowerCase();
            const hasValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
            
            if (!hasValidExtension && file.type !== 'application/json' && file.type !== 'text/plain') {
                showToast('Invalid file type. Please upload a JSON or Base64-encoded file.', 'error');
                clearJsonUpload();
                return;
            }
            
            // Validate file size (max 10MB for large barcode mappings)
            if (file.size > 10 * 1024 * 1024) {
                showToast('File too large. Maximum size is 10MB.', 'error');
                clearJsonUpload();
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileContent = e.target.result;
                    
                    // Detect and decode if Base64
                    const detectionResult = detectAndDecodeBase64(fileContent);
                    const jsonContent = detectionResult.content;
                    
                    // Parse JSON
                    const data = JSON.parse(jsonContent);
                    
                    // Validate JSON structure
                    if (typeof data !== 'object' || data === null || Array.isArray(data)) {
                        throw new Error('JSON must be an object with barcode-description mappings');
                    }
                    
                    // Check if it has at least one key-value pair
                    const entries = Object.entries(data);
                    if (entries.length === 0) {
                        throw new Error('JSON file is empty or has no barcode mappings');
                    }
                    
                    // Validate entries
                    let validCount = 0;
                    for (const [key, value] of entries) {
                        if (typeof key === 'string' && typeof value === 'string') {
                            validCount++;
                        }
                    }
                    
                    if (validCount === 0) {
                        throw new Error('No valid barcode-description mappings found in JSON file');
                    }
                    
                    // Store the mappings
                    AppState.barcodeMappings = data;
                    AppState.lastUploadType = detectionResult.type;
                    
                    // Update UI
                    updateJsonPreview(file, validCount, detectionResult.type);
                    
                    // Show success message
                    const message = detectionResult.type === 'base64' 
                        ? `Loaded ${validCount} barcode mappings from Base64-encoded file`
                        : `Loaded ${validCount} barcode mappings from JSON file`;
                    
                    showToast(message, 'success');
                    playSaveSound();
                    
                    // Save to local storage
                    saveToLocalStorage();
                    
                } catch (error) {
                    console.error('Error parsing file:', error);
                    showToast('Error parsing file: ' + error.message, 'error');
                    clearJsonUpload();
                }
            };
            
            reader.onerror = function() {
                showToast('Error reading file', 'error');
                clearJsonUpload();
            };
            
            reader.readAsText(file);
        }

        // Clear JSON upload
        function clearJsonUpload() {
            if (elements.jsonUploadInput) {
                elements.jsonUploadInput.value = '';
            }
        }

        // Update JSON preview
        function updateJsonPreview(file, mappingCount, fileType) {
            if (!elements.jsonPreview) return;
            
            elements.jsonFileName.textContent = file.name;
            elements.jsonFileSize.textContent = formatFileSize(file.size);
            elements.jsonFileType.textContent = fileType === 'base64' ? 'Base64 Encoded' : 'JSON File';
            elements.mappingsCount.textContent = `${mappingCount} mappings`;
            elements.jsonPreview.style.display = 'flex';
        }

        // Remove JSON file
        function removeJsonFile() {
            AppState.barcodeMappings = {};
            AppState.lastUploadType = null;
            
            if (elements.jsonPreview) {
                elements.jsonPreview.style.display = 'none';
            }
            
            if (elements.jsonUploadInput) {
                elements.jsonUploadInput.value = '';
            }
            
            // Show appropriate message
            showToast('Barcode mappings removed', 'info');
            playClickSound();
            
            // Save to local storage
            saveToLocalStorage();
        }

        // Auto-fill description from barcode
        function autoFillDescriptionFromBarcode(barcode) {
            if (!barcode || !barcode.trim() || !elements.description) return;
            
            // Check if we have a mapping for this barcode
            const description = AppState.barcodeMappings[barcode];
            
            if (description && elements.description.value === '') {
                elements.description.value = description;
                showToast(`Auto-filled description from barcode mapping`, 'info');
            }
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ======================
        // CORE FUNCTIONALITY
        // ======================

        // Launch the system
        function launchSystem() {
            localStorage.setItem('systemLaunched', 'true');
            elements.welcomeScreen.style.display = 'none';
            elements.mainContainer.style.display = 'block';
            showToast('Welcome to Smart Expiry Tracker Pro!', 'success');
            
            // Set expiry date to 30 days from now
            const futureDate = new Date();
            futureDate.setDate(futureDate.getDate() + 30);
            if (elements.expiryDate) {
                elements.expiryDate.value = futureDate.toISOString().split('T')[0];
            }
            
            // Check for urgent items immediately
            checkForUrgentItems();
            
            // Start periodic checks
            startPeriodicChecks();
        }

        // Switch between sections
        function switchSection(section) {
            // Update navigation
            elements.navBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.section === section) {
                    btn.classList.add('active');
                }
            });
            
            // Update sections
            Object.keys(elements.sections).forEach(key => {
                if (elements.sections[key]) {
                    elements.sections[key].style.display = 'none';
                }
            });
            
            if (elements.sections[section]) {
                elements.sections[section].style.display = 'block';
            }
            
            // Update state
            AppState.currentSection = section;
            
            // Load section-specific data
            switch(section) {
                case 'expiring':
                    loadExpiringItems();
                    break;
                case 'expired':
                    loadExpiredItems();
                    if (elements.expiredNotes && AppState.notes.expired) {
                        elements.expiredNotes.value = AppState.notes.expired;
                        elements.expiredNotesDisplay.textContent = AppState.notes.expired || 'No notes added yet.';
                    }
                    break;
                case 'all':
                    loadAllProducts();
                    break;
                case 'alerts':
                    loadAlertSettings();
                    break;
            }
            
            playClickSound();
        }

        // ======================
        // PRODUCT MANAGEMENT
        // ======================

        // Add a new product
        function addProduct(e) {
            e.preventDefault();
            
            // Validate required fields
            if (!elements.barcode.value || !elements.description.value || !elements.expiryDate.value || !elements.quantity.value) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            // Create product object
            const product = {
                id: generateId(),
                barcode: elements.barcode.value,
                description: elements.description.value,
                expiryDate: elements.expiryDate.value,
                category: elements.category.value || 'Other',
                quantity: parseInt(elements.quantity.value),
                customFields: getCustomFields(),
                notes: elements.productNotes ? elements.productNotes.value : '',
                addedDate: new Date().toISOString().split('T')[0],
                daysLeft: calculateDaysLeft(elements.expiryDate.value)
            };
            
            // Add to products array
            AppState.products.push(product);
            
            // Save note for added product
            if (elements.productNotes && elements.productNotes.value) {
                AppState.notes.addedProducts.push({
                    productId: product.id,
                    productName: product.description,
                    note: elements.productNotes.value,
                    date: new Date().toISOString()
                });
            }
            
            // Show success message
            showToast(`Added "${product.description}" successfully!`, 'success');
            playSaveSound();
            
            // Clear form
            clearAddForm();
            
            // Update all displays
            updateAllDisplays();
            
            // Check if urgent
            if (product.daysLeft <= AppState.settings.urgentThreshold) {
                triggerImmediateAlert(`New urgent item added: ${product.description}`);
            }
            
            // Save to local storage
            saveToLocalStorage();
        }

        // Generate a unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Calculate days left until expiry
        function calculateDaysLeft(expiryDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const expiry = new Date(expiryDate);
            expiry.setHours(0, 0, 0, 0);
            
            const diffTime = expiry.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }

        // Get status based on days left
        function getStatus(daysLeft) {
            if (daysLeft < 0) return 'expired';
            if (daysLeft <= AppState.settings.urgentThreshold) return 'urgent';
            if (daysLeft <= AppState.settings.warningThreshold) return 'warning';
            if (daysLeft <= 10) return 'good';
            return 'safe';
        }

        // Get status class
        function getStatusClass(daysLeft) {
            const status = getStatus(daysLeft);
            switch(status) {
                case 'expired': return 'status-expired';
                case 'urgent': return 'status-urgent';
                case 'warning': return 'status-warning';
                case 'good': return 'status-good';
                default: return 'status-safe';
            }
        }

        // Get status text
        function getStatusText(daysLeft) {
            const status = getStatus(daysLeft);
            switch(status) {
                case 'expired': return 'EXPIRED';
                case 'urgent': return 'URGENT';
                case 'warning': return 'WARNING';
                case 'good': return 'GOOD';
                default: return 'SAFE';
            }
        }

        // Generate barcode
        function generateBarcode() {
            const prefix = 'PROD';
            const random = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
            elements.barcode.value = `${prefix}-${random}`;
            playClickSound();
        }

        // Get custom fields from form
        function getCustomFields() {
            const customFields = {};
            const fieldElements = document.querySelectorAll('.custom-field-group');
            
            fieldElements.forEach(field => {
                const keyInput = field.querySelector('.field-key');
                const valueInput = field.querySelector('.field-value');
                
                if (keyInput && valueInput) {
                    const key = keyInput.value;
                    const value = valueInput.value;
                    if (key && value) {
                        customFields[key] = value;
                    }
                }
            });
            
            return customFields;
        }

        // Add custom field
        function addCustomField() {
            const container = document.getElementById('customFieldsContainer');
            if (!container) return;
            
            const fieldId = `custom-field-${Date.now()}`;
            
            const fieldHTML = `
                <div class="custom-field-group" id="${fieldId}">
                    <input type="text" class="form-control field-key" placeholder="Field Name (e.g., Storage)">
                    <input type="text" class="form-control field-value" placeholder="Field Value (e.g., Refrigerate)">
                    <button type="button" class="btn btn-danger remove-field-btn" onclick="removeCustomField('${fieldId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', fieldHTML);
            playClickSound();
        }

        // Remove custom field
        function removeCustomField(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.remove();
                playClickSound();
            }
        }

        // Clear add form
        function clearAddForm() {
            elements.addProductForm.reset();
            elements.category.value = 'Beverages and Dairy';
            if (elements.productNotes) {
                elements.productNotes.value = '';
            }
            
            // Clear custom fields
            const container = document.getElementById('customFieldsContainer');
            if (container) {
                container.innerHTML = '';
            }
            
            // Set expiry date to 30 days from now
            const futureDate = new Date();
            futureDate.setDate(futureDate.getDate() + 30);
            elements.expiryDate.value = futureDate.toISOString().split('T')[0];
        }

        // Generate random product for testing
        function generateRandomProduct() {
            const products = [
                { barcode: 'MILK-001', desc: 'Fresh Milk 1L', category: 'Beverages and Dairy', days: 5 },
                { barcode: 'CHOC-002', desc: 'Chocolate Bar 100g', category: 'Confectionery', days: 30 },
                { barcode: 'RICE-003', desc: 'Basmati Rice 5kg', category: 'Grocery', days: 90 },
                { barcode: 'ICE-004', desc: 'Vanilla Ice Cream', category: 'Ice Cream', days: 15 },
                { barcode: 'CHPS-005', desc: 'Potato Chips 200g', category: 'Snacks', days: 45 }
            ];
            
            const random = products[Math.floor(Math.random() * products.length)];
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + random.days);
            
            elements.barcode.value = random.barcode;
            elements.description.value = random.desc;
            elements.category.value = random.category;
            elements.expiryDate.value = expiryDate.toISOString().split('T')[0];
            elements.quantity.value = Math.floor(Math.random() * 50) + 10;
            
            showToast('Random product generated', 'info');
            playClickSound();
        }

        // ======================
        // DISPLAY FUNCTIONS
        // ======================

        // Update all displays
        function updateAllDisplays() {
            updateCounts();
            loadExpiringItems();
            loadExpiredItems();
            loadAllProducts();
            checkForUrgentItems();
            updateFooterStats();
        }

        // Update counts
        function updateCounts() {
            const total = AppState.products.length;
            const urgent = AppState.products.filter(p => p.daysLeft <= AppState.settings.urgentThreshold && p.daysLeft >= 0).length;
            const expired = AppState.products.filter(p => p.daysLeft < 0).length;
            const expiring = AppState.products.filter(p => p.daysLeft >= 0 && p.daysLeft <= 10).length;
            
            // Update main counts
            if (elements.totalItems) elements.totalItems.textContent = total;
            if (elements.urgentCount) elements.urgentCount.textContent = urgent;
            if (elements.navUrgentCount) {
                elements.navUrgentCount.textContent = urgent;
                elements.navUrgentCount.style.display = urgent > 0 ? 'flex' : 'none';
            }
            if (elements.navExpiredCount) {
                elements.navExpiredCount.textContent = expired;
                elements.navExpiredCount.style.display = expired > 0 ? 'flex' : 'none';
            }
            if (elements.expiringCount) elements.expiringCount.textContent = expiring;
            if (elements.expiredCount) elements.expiredCount.textContent = expired;
            if (elements.allProductsCount) elements.allProductsCount.textContent = total;
            
            // Update statistics
            updateStatistics();
        }

        // Update statistics
        function updateStatistics() {
            const urgent = AppState.products.filter(p => p.daysLeft <= AppState.settings.urgentThreshold && p.daysLeft >= 0).length;
            const warning = AppState.products.filter(p => p.daysLeft > AppState.settings.urgentThreshold && p.daysLeft <= AppState.settings.warningThreshold).length;
            const good = AppState.products.filter(p => p.daysLeft > AppState.settings.warningThreshold && p.daysLeft <= 10).length;
            const categories = new Set(AppState.products.map(p => p.category)).size;
            
            if (elements.urgentStat) elements.urgentStat.textContent = urgent;
            if (elements.warningStat) elements.warningStat.textContent = warning;
            if (elements.goodStat) elements.goodStat.textContent = good;
            if (elements.categoryStat) elements.categoryStat.textContent = categories;
        }

        // Load expiring items
        function loadExpiringItems() {
            const container = elements.expiringBubbles;
            const emptyState = elements.noExpiringItems;
            
            if (!container || !emptyState) return;
            
            // Filter items expiring in next 10 days
            const expiringItems = AppState.products.filter(product => {
                return product.daysLeft >= 0 && product.daysLeft <= 10;
            });
            
            if (expiringItems.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = '';
            
            // Sort by days left (closest first)
            expiringItems.sort((a, b) => a.daysLeft - b.daysLeft);
            
            // Create bubbles for each item
            expiringItems.forEach(product => {
                const bubble = createExpiryBubble(product);
                container.appendChild(bubble);
            });
        }

        // Create expiry bubble element
        function createExpiryBubble(product) {
            const bubble = document.createElement('div');
            bubble.className = `expiry-bubble ${getBubbleClass(product.daysLeft)}`;
            bubble.dataset.id = product.id;
            
            // Add category class
            const categoryClass = `category-${product.category.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;
            bubble.classList.add(categoryClass);
            
            let badgeHTML = '';
            if (product.daysLeft <= AppState.settings.urgentThreshold) {
                badgeHTML = `
                    <div class="urgent-badge">
                        URGENT
                    </div>
                `;
            }
            
            bubble.innerHTML = `
                ${badgeHTML}
                <div class="bubble-header">
                    <div class="barcode">${product.barcode}</div>
                    <div class="expiry-date">${formatDate(product.expiryDate)}</div>
                </div>
                <div class="product-description">${product.description}</div>
                <div class="product-quantity">
                    <i class="fas fa-cubes"></i>
                    Quantity: ${product.quantity}
                </div>
                <div class="days-left">
                    ${product.daysLeft === 0 ? 'Expires TODAY!' : 
                      product.daysLeft < 0 ? `${Math.abs(product.daysLeft)} days expired` : 
                      `${product.daysLeft} days left`}
                </div>
            `;
            
            // Add click event to show details
            bubble.addEventListener('click', () => {
                showProductDetails(product.id);
            });
            
            return bubble;
        }

        // Get bubble class based on days left
        function getBubbleClass(daysLeft) {
            if (daysLeft <= AppState.settings.urgentThreshold) return 'urgent';
            if (daysLeft <= AppState.settings.warningThreshold) return 'warning';
            if (daysLeft <= 10) return 'good';
            return '';
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Load expired items
        function loadExpiredItems() {
            const tableBody = elements.expiredTableBody;
            const emptyState = elements.noExpiredItems;
            
            if (!tableBody || !emptyState) return;
            
            // Filter expired items
            const expiredItems = AppState.products.filter(product => product.daysLeft < 0);
            
            if (expiredItems.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                if (elements.expiredNotesDisplay) {
                    elements.expiredNotesDisplay.textContent = 'No notes added yet.';
                }
                return;
            }
            
            emptyState.style.display = 'none';
            tableBody.innerHTML = '';
            
            // Sort by most expired first
            expiredItems.sort((a, b) => a.daysLeft - b.daysLeft);
            
            // Add rows to table
            expiredItems.forEach(product => {
                const row = createExpiredTableRow(product);
                tableBody.appendChild(row);
            });
            
            // Update selected count
            updateSelectedExpired();
        }

        // Create expired table row
        function createExpiredTableRow(product) {
            const row = document.createElement('tr');
            row.dataset.id = product.id;
            
            row.innerHTML = `
                <td>
                    <input type="checkbox" class="expired-checkbox" data-id="${product.id}" onchange="updateSelectedExpired()">
                </td>
                <td>${product.barcode}</td>
                <td>${product.description}</td>
                <td>${product.quantity}</td>
                <td>${product.category}</td>
                <td>${formatDate(product.expiryDate)}</td>
                <td>
                    <span class="status-badge status-expired">
                        ${Math.abs(product.daysLeft)} days
                    </span>
                </td>
                <td>
                    <div class="action-btn-container">
                        <button class="action-btn" onclick="event.stopPropagation(); editProduct('${product.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn" onclick="event.stopPropagation(); showDeleteModal('${product.id}', '${product.description}')" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </td>
            `;
            
            // Make entire row clickable for details (except action buttons)
            row.addEventListener('click', function(e) {
                if (!e.target.closest('.action-btn') && !e.target.closest('input[type="checkbox"]')) {
                    showProductDetails(product.id);
                }
            });
            
            return row;
        }

        // Load all products
        function loadAllProducts() {
            const tableBody = elements.allProductsTableBody;
            const emptyState = elements.noProducts;
            
            if (!tableBody || !emptyState) return;
            
            if (AppState.products.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            tableBody.innerHTML = '';
            
            // Apply filtering
            let filtered = [...AppState.products];
            
            // Apply search filter
            const searchTerm = elements.searchProducts ? elements.searchProducts.value.toLowerCase() : '';
            if (searchTerm) {
                filtered = filtered.filter(product => 
                    product.description.toLowerCase().includes(searchTerm) ||
                    product.barcode.toLowerCase().includes(searchTerm) ||
                    (product.category && product.category.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply category filter
            const categoryFilter = elements.filterCategory ? elements.filterCategory.value : '';
            if (categoryFilter) {
                filtered = filtered.filter(product => product.category === categoryFilter);
            }
            
            // Apply status filter
            const statusFilter = elements.filterStatus ? elements.filterStatus.value : '';
            if (statusFilter) {
                filtered = filtered.filter(product => {
                    const status = getStatus(product.daysLeft);
                    return status === statusFilter;
                });
            }
            
            // Apply sorting
            const sortFilter = elements.filterSort ? elements.filterSort.value : 'expiry-asc';
            switch(sortFilter) {
                case 'expiry-asc':
                    filtered.sort((a, b) => a.daysLeft - b.daysLeft);
                    break;
                case 'expiry-desc':
                    filtered.sort((a, b) => b.daysLeft - a.daysLeft);
                    break;
                case 'name-asc':
                    filtered.sort((a, b) => a.description.localeCompare(b.description));
                    break;
                case 'name-desc':
                    filtered.sort((a, b) => b.description.localeCompare(a.description));
                    break;
            }
            
            // Update filtered products state
            AppState.filteredProducts = filtered;
            
            // Add rows to table
            filtered.forEach(product => {
                const row = createAllProductsTableRow(product);
                tableBody.appendChild(row);
            });
            
            // Update selected count
            updateSelectedProducts();
        }

        // Create all products table row
        function createAllProductsTableRow(product) {
            const row = document.createElement('tr');
            row.dataset.id = product.id;
            
            const statusClass = getStatusClass(product.daysLeft);
            const statusText = getStatusText(product.daysLeft);
            
            row.innerHTML = `
                <td>
                    <input type="checkbox" class="product-checkbox" data-id="${product.id}" onchange="updateSelectedProducts()">
                </td>
                <td>${product.barcode}</td>
                <td>${product.description}</td>
                <td>${product.quantity}</td>
                <td>${product.category}</td>
                <td>${formatDate(product.expiryDate)}</td>
                <td>
                    <span class="status-badge ${statusClass}">
                        ${product.daysLeft < 0 ? Math.abs(product.daysLeft) + ' days expired' : 
                          product.daysLeft + ' days left'}
                    </span>
                </td>
                <td>
                    <span class="status-badge ${statusClass}">
                        ${statusText}
                    </span>
                </td>
                <td>
                    <div class="action-btn-container">
                        <button class="action-btn" onclick="event.stopPropagation(); editProduct('${product.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn" onclick="event.stopPropagation(); showDeleteModal('${product.id}', '${product.description}')" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </td>
            `;
            
            // Make entire row clickable for details (except action buttons)
            row.addEventListener('click', function(e) {
                if (!e.target.closest('.action-btn') && !e.target.closest('input[type="checkbox"]')) {
                    showProductDetails(product.id);
                }
            });
            
            return row;
        }

        // Filter products
        function filterProducts() {
            loadAllProducts();
        }

        // ======================
        // PRODUCT OPERATIONS
        // ======================

        // Show delete modal
        function showDeleteModal(productId, productName) {
            AppState.currentProductToDelete = productId;
            if (elements.deleteMessage) {
                elements.deleteMessage.textContent = `Are you sure you want to delete "${productName}"? This action cannot be undone.`;
            }
            if (elements.deleteModal) {
                elements.deleteModal.classList.add('active');
            }
            playClickSound();
        }

        // Hide delete modal
        function hideDeleteModal() {
            if (elements.deleteModal) {
                elements.deleteModal.classList.remove('active');
            }
            AppState.currentProductToDelete = null;
            playClickSound();
        }

        // Confirm deletion
        function confirmDeletion() {
            if (!AppState.currentProductToDelete) return;
            
            // Remove product from array
            const index = AppState.products.findIndex(p => p.id === AppState.currentProductToDelete);
            if (index !== -1) {
                const productName = AppState.products[index].description;
                AppState.products.splice(index, 1);
                
                // Show toast
                showToast(`"${productName}" deleted successfully`, 'success');
                playDeleteSound();
                
                // Update all displays
                updateAllDisplays();
                
                // Save to local storage
                saveToLocalStorage();
            }
            
            // Hide modal
            hideDeleteModal();
        }

        // Edit product
        function editProduct(productId) {
            const product = AppState.products.find(p => p.id === productId);
            if (!product) return;
            
            // Switch to add section
            switchSection('add');
            
            // Fill form with product data
            elements.barcode.value = product.barcode;
            elements.description.value = product.description;
            elements.expiryDate.value = product.expiryDate;
            elements.category.value = product.category;
            elements.quantity.value = product.quantity;
            
            // Set product notes
            if (elements.productNotes) {
                elements.productNotes.value = product.notes || '';
            }
            
            // Add custom fields
            const container = document.getElementById('customFieldsContainer');
            if (container) {
                container.innerHTML = '';
                
                if (product.customFields) {
                    Object.entries(product.customFields).forEach(([key, value]) => {
                        const fieldId = `custom-field-${Date.now()}-${key}`;
                        container.innerHTML += `
                            <div class="custom-field-group" id="${fieldId}">
                                <input type="text" class="form-control field-key" value="${key}" placeholder="Field Name">
                                <input type="text" class="form-control field-value" value="${value}" placeholder="Field Value">
                                <button type="button" class="btn btn-danger remove-field-btn" onclick="removeCustomField('${fieldId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                    });
                }
            }
            
            // Change form submit to update instead of add
            elements.addProductForm.onsubmit = function(e) {
                e.preventDefault();
                updateProduct(productId);
            };
            
            // Change button text
            const submitBtn = elements.addProductForm.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Product';
            }
            
            showToast('Edit product details', 'info');
            playClickSound();
        }

        // Update product
        function updateProduct(productId) {
            const index = AppState.products.findIndex(p => p.id === productId);
            if (index === -1) return;
            
            // Update product
            AppState.products[index] = {
                ...AppState.products[index],
                barcode: elements.barcode.value,
                description: elements.description.value,
                expiryDate: elements.expiryDate.value,
                category: elements.category.value || 'Other',
                quantity: parseInt(elements.quantity.value),
                customFields: getCustomFields(),
                notes: elements.productNotes ? elements.productNotes.value : '',
                daysLeft: calculateDaysLeft(elements.expiryDate.value)
            };
            
            // Show success message
            showToast(`Updated "${AppState.products[index].description}" successfully!`, 'success');
            playSaveSound();
            
            // Reset form
            clearAddForm();
            
            // Restore original form submit handler
            elements.addProductForm.onsubmit = addProduct;
            
            // Restore button text
            const submitBtn = elements.addProductForm.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Product';
            }
            
            // Update all displays
            updateAllDisplays();
            
            // Save to local storage
            saveToLocalStorage();
        }

        // Show product details
        function showProductDetails(productId) {
            const product = AppState.products.find(p => p.id === productId);
            if (!product) return;
            
            AppState.currentProductToView = productId;
            
            const statusClass = getStatusClass(product.daysLeft);
            const statusText = getStatusText(product.daysLeft);
            
            let customFieldsHTML = '';
            if (product.customFields && Object.keys(product.customFields).length > 0) {
                customFieldsHTML = `
                    <div class="detail-item">
                        <div class="detail-label">
                            <i class="fas fa-plus-square"></i> Additional Information
                        </div>
                        <div style="margin-top: 10px;">
                            ${Object.entries(product.customFields).map(([key, value]) => `
                                <div class="custom-field-display">
                                    <div class="custom-field-key">${key}</div>
                                    <div class="custom-field-value">${value}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            let notesHTML = '';
            if (product.notes) {
                notesHTML = `
                    <div class="detail-item">
                        <div class="detail-label">
                            <i class="fas fa-sticky-note"></i> Product Notes
                        </div>
                        <div class="detail-value" style="background: #f8fafc; padding: 15px; border-radius: var(--radius-sm); margin-top: 10px;">
                            ${product.notes}
                        </div>
                    </div>
                `;
            }
            
            const modalHTML = `
                <div style="
                    width: 100px;
                    height: 100px;
                    background: var(--primary-gradient);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 25px;
                    box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
                    border: 3px solid rgba(255, 255, 255, 0.5);
                ">
                    <i class="fas fa-box" style="font-size: 48px; color: white;"></i>
                </div>
                <h2 style="color: #667eea; font-size: 28px; text-align: center; margin-bottom: 10px;">${product.description}</h2>
                <div style="
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 50px;
                    display: inline-block;
                    margin: 0 auto 30px;
                    font-weight: 700;
                    font-size: 14px;
                    text-transform: uppercase;
                    letter-spacing: 1.2px;
                ">${product.category}</div>
                
                <div class="modal-scrollable">
                    <div style="
                        background: linear-gradient(135deg, #f8fafc, #edf2f7);
                        padding: 25px;
                        border-radius: var(--radius-lg);
                        margin-bottom: 30px;
                    ">
                        <!-- Basic Information Grid -->
                        <div class="product-details-grid">
                            <div class="detail-item">
                                <div class="detail-label">
                                    <i class="fas fa-barcode"></i> Barcode
                                </div>
                                <div class="detail-value">${product.barcode}</div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">
                                    <i class="fas fa-calendar-alt"></i> Expiry Date
                                </div>
                                <div class="detail-value">${formatDate(product.expiryDate)}</div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">
                                    <i class="fas fa-cubes"></i> Quantity
                                </div>
                                <div class="detail-value">${product.quantity}</div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">
                                    <i class="fas fa-calendar-plus"></i> Added Date
                                </div>
                                <div class="detail-value">${formatDate(product.addedDate)}</div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">
                                    <i class="fas fa-clock"></i> Status
                                </div>
                                <div class="detail-value">
                                    <span class="status-badge ${statusClass}" style="margin-top: 5px; display: inline-block;">
                                        ${statusText}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">
                                    <i class="fas fa-hourglass-half"></i> Days ${product.daysLeft < 0 ? 'Expired' : 'Left'}
                                </div>
                                <div class="detail-value" style="font-weight: 700; color: ${product.daysLeft <= 3 ? '#ff416c' : product.daysLeft <= 7 ? '#f7971e' : '#56ab2f'}">
                                    ${Math.abs(product.daysLeft)} days
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes Section -->
                        ${notesHTML}
                        
                        <!-- Custom Fields Section -->
                        ${customFieldsHTML}
                    </div>
                </div>
            `;
            
            elements.productDetailsContent.innerHTML = modalHTML;
            elements.productDetailsModal.classList.add('active');
            playClickSound();
        }

        // Hide product details modal
        function hideProductDetailsModal() {
            elements.productDetailsModal.classList.remove('active');
            AppState.currentProductToView = null;
            playClickSound();
        }

        // ======================
        // BULK OPERATIONS
        // ======================

        // Update selected expired items
        function updateSelectedExpired() {
            const checkboxes = document.querySelectorAll('.expired-checkbox:checked');
            AppState.selectedExpired = Array.from(checkboxes).map(cb => cb.dataset.id);
            
            const selectedCount = document.getElementById('selectedCount');
            if (selectedCount) {
                selectedCount.textContent = AppState.selectedExpired.length;
            }
        }

        // Update selected products
        function updateSelectedProducts() {
            const checkboxes = document.querySelectorAll('.product-checkbox:checked');
            AppState.selectedProducts = Array.from(checkboxes).map(cb => cb.dataset.id);
            
            const selectedProductsCount = document.getElementById('selectedProductsCount');
            if (selectedProductsCount) {
                selectedProductsCount.textContent = AppState.selectedProducts.length;
            }
        }

        // Toggle select all expired
        function toggleSelectAllExpired() {
            const selectAll = document.getElementById('selectAllExpired');
            const checkboxes = document.querySelectorAll('.expired-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            
            updateSelectedExpired();
        }

        // Toggle select all products
        function toggleSelectAllProducts() {
            const selectAll = document.getElementById('selectAllHeader');
            const checkboxes = document.querySelectorAll('.product-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            
            updateSelectedProducts();
        }

        // Bulk delete selected expired items
        function bulkDeleteSelected() {
            if (AppState.selectedExpired.length === 0) {
                showToast('No items selected', 'warning');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${AppState.selectedExpired.length} expired items?`)) {
                return;
            }
            
            // Remove selected items
            AppState.products = AppState.products.filter(product => 
                !AppState.selectedExpired.includes(product.id)
            );
            
            // Clear selection
            AppState.selectedExpired = [];
            
            // Update displays
            updateAllDisplays();
            
            // Show success message
            showToast(`Deleted ${AppState.selectedExpired.length} expired items`, 'success');
            playDeleteSound();
            
            // Save to local storage
            saveToLocalStorage();
        }

        // Bulk delete selected products
        function bulkDeleteSelectedProducts() {
            if (AppState.selectedProducts.length === 0) {
                showToast('No items selected', 'warning');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${AppState.selectedProducts.length} products?`)) {
                return;
            }
            
            // Remove selected items
            AppState.products = AppState.products.filter(product => 
                !AppState.selectedProducts.includes(product.id)
            );
            
            // Clear selection
            AppState.selectedProducts = [];
            
            // Update displays
            updateAllDisplays();
            
            // Show success message
            showToast(`Deleted ${AppState.selectedProducts.length} products`, 'success');
            playDeleteSound();
            
            // Save to local storage
            saveToLocalStorage();
        }

        // Bulk delete all expired items
        function bulkDeleteExpired() {
            const expiredCount = AppState.products.filter(p => p.daysLeft < 0).length;
            
            if (expiredCount === 0) {
                showToast('No expired items to delete', 'info');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete all ${expiredCount} expired items?`)) {
                return;
            }
            
            // Remove all expired items
            AppState.products = AppState.products.filter(product => product.daysLeft >= 0);
            
            // Update displays
            updateAllDisplays();
            
            // Show success message
            showToast(`Deleted all ${expiredCount} expired items`, 'success');
            playDeleteSound();
            
            // Save to local storage
            saveToLocalStorage();
        }

        // ======================
        // IMPORT/EXPORT
        // ======================

        // Export data
        function exportData() {
            const data = {
                products: AppState.products,
                barcodeMappings: AppState.barcodeMappings,
                settings: AppState.settings,
                notes: AppState.notes,
                exportDate: new Date().toISOString(),
                version: '4.3' // Updated version for Base64 support
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `expiry-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Data exported successfully', 'success');
            playClickSound();
        }

        // Export expired only
        function exportExpiredOnly() {
            const expiredItems = AppState.products.filter(p => p.daysLeft < 0);
            
            if (expiredItems.length === 0) {
                showToast('No expired items to export', 'warning');
                return;
            }
            
            const data = {
                products: expiredItems,
                exportDate: new Date().toISOString(),
                totalExpired: expiredItems.length
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `expired-items-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`Exported ${expiredItems.length} expired items`, 'success');
            playClickSound();
        }

        // Import data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileContent = e.target.result;
                    
                    // Detect and decode if Base64
                    let jsonContent;
                    try {
                        const detectionResult = detectAndDecodeBase64(fileContent);
                        jsonContent = detectionResult.content;
                        console.log('File type detected:', detectionResult.type);
                    } catch (decodeError) {
                        // If decode fails, assume it's regular JSON
                        jsonContent = fileContent;
                    }
                    
                    const data = JSON.parse(jsonContent);
                    
                    if (!data.products || !Array.isArray(data.products)) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Clear current data or merge?
                    if (confirm('Do you want to replace current data with imported data?')) {
                        AppState.products = data.products;
                        
                        // Update days left for all products
                        AppState.products.forEach(product => {
                            product.daysLeft = calculateDaysLeft(product.expiryDate);
                        });
                        
                        // Load barcode mappings if available
                        if (data.barcodeMappings) {
                            AppState.barcodeMappings = data.barcodeMappings;
                            updateJsonPreviewAfterImport(data.barcodeMappings);
                        }
                        
                        if (data.settings) {
                            AppState.settings = { ...AppState.settings, ...data.settings };
                            loadAlertSettings();
                        }
                        
                        if (data.notes) {
                            AppState.notes = data.notes;
                        }
                        
                        showToast(`Imported ${data.products.length} products successfully`, 'success');
                        updateAllDisplays();
                        saveToLocalStorage();
                    }
                    
                } catch (error) {
                    showToast('Error importing data: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
            playClickSound();
        }

        // Update JSON preview after import
        function updateJsonPreviewAfterImport(mappings) {
            if (!elements.jsonPreview || Object.keys(mappings).length === 0) return;
            
            const mappingCount = Object.keys(mappings).length;
            elements.jsonFileName.textContent = 'Imported from backup';
            elements.jsonFileSize.textContent = 'N/A';
            elements.jsonFileType.textContent = 'JSON File';
            elements.mappingsCount.textContent = `${mappingCount} mappings`;
            elements.jsonPreview.style.display = 'flex';
        }

        // ======================
        // UTILITY FUNCTIONS
        // ======================

        // Show toast notification
        function showToast(message, type = 'info') {
            if (!elements.toast || !elements.toastMessage) return;
            
            const toast = elements.toast;
            const toastMessage = elements.toastMessage;
            
            // Set message and type
            toastMessage.textContent = message;
            toast.className = 'toast'; // Reset classes
            
            // Add type class
            if (type === 'error') {
                toast.classList.add('toast-error');
                toast.querySelector('i').className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                toast.classList.add('toast-warning');
                toast.querySelector('i').className = 'fas fa-exclamation-triangle';
            } else if (type === 'success') {
                toast.classList.add('toast-success');
                toast.querySelector('i').className = 'fas fa-check-circle';
            } else if (type === 'urgent') {
                toast.classList.add('toast-urgent');
                toast.querySelector('i').className = 'fas fa-bell';
            } else {
                toast.classList.add('toast-info');
                toast.querySelector('i').className = 'fas fa-info-circle';
            }
            
            // Show toast
            toast.classList.add('active');
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                toast.classList.remove('active');
            }, 5000);
        }

        // Update current year in footer
        function updateCurrentYear() {
            const currentYear = document.getElementById('currentYear');
            if (currentYear) {
                currentYear.textContent = new Date().getFullYear();
            }
        }

        // Initialize welcome screen
        function initializeWelcomeScreen() {
            // Check if already launched
            const launched = localStorage.getItem('systemLaunched');
            if (launched) {
                elements.welcomeScreen.style.display = 'none';
                elements.mainContainer.style.display = 'block';
                loadFromLocalStorage();
                startPeriodicChecks();
            }
        }

        // Print data
        function printData() {
            window.print();
        }

        // ======================
        // ALERT SYSTEM
        // ======================

        // Check for urgent items
        function checkForUrgentItems() {
            if (AppState.acknowledgedAlerts) return;
            
            const urgentItems = AppState.products.filter(p => 
                p.daysLeft >= 0 && p.daysLeft <= AppState.settings.urgentThreshold
            );
            
            if (urgentItems.length > 0) {
                showUrgentAlert(urgentItems.length, urgentItems);
                
                // Start continuous alerts if enabled
                if (AppState.settings.continuousAlert && !AppState.alertTimeout) {
                    startContinuousAlerts();
                }
            }
            
            updateAlertIndicator();
        }

        // Show urgent alert
        function showUrgentAlert(count, items) {
            // Update alert indicator
            if (elements.alertCountText) {
                elements.alertCountText.textContent = `${count} items expiring soon!`;
            }
            
            if (elements.soundAlertIndicator) {
                elements.soundAlertIndicator.classList.add('active');
            }
            
            // Play alert sound if enabled
            if (AppState.settings.immediateAlert) {
                playAlertSound();
            }
            
            // Show urgent toast
            if (count > 0) {
                showToast(`${count} urgent items need attention!`, 'urgent');
            }
        }

        // Play alert sound
        function playAlertSound() {
            try {
                // Use custom sound if available and enabled
                if (AppState.settings.useCustomSound && audioElements.custom.src) {
                    audioElements.custom.volume = AppState.settings.alertVolume / 100;
                    audioElements.custom.currentTime = 0;
                    audioElements.custom.play().catch(e => {
                        console.log('Custom alert sound play failed, using default:', e);
                        playDefaultAlertSound();
                    });
                } else {
                    playDefaultAlertSound();
                }
            } catch (e) {
                console.log('Alert sound error, trying fallback:', e);
                playDefaultAlertSound();
            }
        }

        // Play default alert sound
        function playDefaultAlertSound() {
            try {
                if (!audioElements.alert.src) {
                    // Generate a simple beep sound
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } else {
                    // Use existing audio element
                    audioElements.alert.volume = AppState.settings.alertVolume / 100;
                    audioElements.alert.currentTime = 0;
                    audioElements.alert.play().catch(e => {
                        console.log('Alert sound play failed, trying alternative:', e);
                        tryFallbackSound();
                    });
                }
            } catch (e) {
                console.log('Audio error, trying fallback:', e);
                tryFallbackSound();
            }
        }

        // Fallback sound using Web Audio API
        function tryFallbackSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 600;
                oscillator.type = 'sine';
                
                // Volume based on settings
                const volume = AppState.settings.alertVolume / 100 * 0.5;
                gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.8);
            } catch (e) {
                console.log('Fallback sound also failed:', e);
            }
        }

        // Stop all sounds
        function stopAllSounds() {
            try {
                Object.values(audioElements).forEach(audio => {
                    if (audio && typeof audio.pause === 'function') {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                });
            } catch (e) {
                console.log('Error stopping sounds:', e);
            }
        }

        // Start continuous alerts
        function startContinuousAlerts() {
            if (AppState.alertTimeout) {
                clearTimeout(AppState.alertTimeout);
            }
            
            const frequency = getAlertFrequencyMs();
            
            AppState.alertTimeout = setTimeout(() => {
                if (!AppState.acknowledgedAlerts) {
                    const urgentItems = AppState.products.filter(p => 
                        p.daysLeft >= 0 && p.daysLeft <= AppState.settings.urgentThreshold
                    );
                    
                    if (urgentItems.length > 0) {
                        playAlertSound();
                        startContinuousAlerts(); // Continue
                    }
                }
            }, frequency);
        }

        // Get alert frequency in milliseconds
        function getAlertFrequencyMs() {
            switch(AppState.settings.alertFrequency) {
                case 'once': return 0;
                case '5min': return 5 * 60 * 1000;
                case '15min': return 15 * 60 * 1000;
                case '30min': return 30 * 60 * 1000;
                case 'hourly': return 60 * 60 * 1000;
                default: return 5 * 60 * 1000;
            }
        }

        // Acknowledge alerts
        function acknowledgeAlerts() {
            AppState.acknowledgedAlerts = true;
            
            if (elements.soundAlertIndicator) {
                elements.soundAlertIndicator.classList.remove('active');
            }
            
            showToast('Alerts acknowledged', 'success');
            playClickSound();
            
            // Stop all sounds
            stopAllSounds();
            
            // Clear continuous alert timeout
            if (AppState.alertTimeout) {
                clearTimeout(AppState.alertTimeout);
                AppState.alertTimeout = null;
            }
        }

        // Test urgent alert
        function testUrgentAlert() {
            // Create a test alert
            showUrgentAlert(3, []);
            showToast('Testing urgent alert system', 'info');
            playClickSound();
        }

        // Trigger immediate alert
        function triggerImmediateAlert(message) {
            if (AppState.settings.immediateAlert) {
                playAlertSound();
                showToast(message, 'urgent');
            }
        }

        // Update alert indicator
        function updateAlertIndicator() {
            const urgentItems = AppState.products.filter(p => 
                p.daysLeft >= 0 && p.daysLeft <= AppState.settings.urgentThreshold
            );
            
            if (urgentItems.length > 0 && !AppState.acknowledgedAlerts) {
                if (elements.soundAlertIndicator) {
                    elements.soundAlertIndicator.classList.add('active');
                }
                if (elements.alertCountText) {
                    elements.alertCountText.textContent = `${urgentItems.length} items expiring soon!`;
                }
            } else {
                if (elements.soundAlertIndicator) {
                    elements.soundAlertIndicator.classList.remove('active');
                }
            }
        }

        // Start periodic checks
        function startPeriodicChecks() {
            if (AppState.alertInterval) {
                clearInterval(AppState.alertInterval);
            }
            
            AppState.alertInterval = setInterval(() => {
                checkForUrgentItems();
            }, 60000); // Check every minute
        }

        // ======================
        // SOUND MANAGEMENT
        // ======================

        // Initialize sound effects
        function initializeSoundEffects() {
            // Generate simple tones using Web Audio API
            try {
                // Save sound (higher pitch, short)
                audioElements.save.src = generateToneURL(800, 0.3, 0.3);
                
                // Delete sound (lower pitch, short)
                audioElements.delete.src = generateToneURL(400, 0.3, 0.3);
                
                // Alert sound (medium pitch, longer)
                audioElements.alert.src = generateToneURL(600, 0.5, 0.8);
                
                // Notification sound (high pitch, short)
                audioElements.notification.src = generateToneURL(1000, 0.4, 0.2);
                
                // Click sound (very short click)
                audioElements.click.src = generateClickSoundURL();
                
                // Set initial volumes
                updateAlertVolume(80);
                
                console.log('Sound system initialized successfully');
            } catch (e) {
                console.log('Error initializing sound effects:', e);
                // Fallback: Use simple data URLs
                setupFallbackSounds();
            }
        }

        // Generate tone as data URL
        function generateToneURL(frequency, volume, duration) {
            try {
                const sampleRate = 44100;
                const channels = 1;
                const samples = Math.floor(sampleRate * duration);
                
                // Create audio context
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const buffer = audioContext.createBuffer(channels, samples, sampleRate);
                const channelData = buffer.getChannelData(0);
                
                // Generate sine wave
                for (let i = 0; i < samples; i++) {
                    const time = i / sampleRate;
                    channelData[i] = Math.sin(2 * Math.PI * frequency * time) * volume * Math.exp(-time * 2);
                }
                
                // Convert to WAV
                const wav = audioBufferToWav(buffer);
                return URL.createObjectURL(new Blob([wav], { type: 'audio/wav' }));
            } catch (e) {
                console.log('Error generating tone, using fallback:', e);
                return 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ';
            }
        }

        // Generate click sound
        function generateClickSoundURL() {
            try {
                const sampleRate = 44100;
                const duration = 0.1;
                const samples = Math.floor(sampleRate * duration);
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const buffer = audioContext.createBuffer(1, samples, sampleRate);
                const channelData = buffer.getChannelData(0);
                
                // Generate click
                for (let i = 0; i < samples; i++) {
                    const time = i / sampleRate;
                    if (time < 0.01) {
                        channelData[i] = Math.random() * 0.5;
                    } else {
                        channelData[i] = 0;
                    }
                }
                
                const wav = audioBufferToWav(buffer);
                return URL.createObjectURL(new Blob([wav], { type: 'audio/wav' }));
            } catch (e) {
                console.log('Error generating click sound:', e);
                return generateToneURL(200, 0.1, 0.05);
            }
        }

        // Convert AudioBuffer to WAV
        function audioBufferToWav(buffer) {
            const numChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const format = 1;
            const bitDepth = 16;
            
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;
            
            const wav = new Uint8Array(44 + buffer.length * blockAlign);
            const view = new DataView(wav.buffer);
            
            // Write WAV header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + buffer.length * blockAlign, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, buffer.length * blockAlign, true);
            
            // Write audio data
            const channelData = buffer.getChannelData(0);
            for (let i = 0; i < channelData.length; i++) {
                const sample = Math.max(-1, Math.min(1, channelData[i]));
                const intSample = sample < 0 ? sample * 32768 : sample * 32767;
                view.setInt16(44 + i * 2, intSample, true);
            }
            
            return wav;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Setup fallback sounds
        function setupFallbackSounds() {
            // Simple fallback sounds using base64 encoded silent audio
            const silentAudio = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ';
            audioElements.save.src = silentAudio;
            audioElements.delete.src = silentAudio;
            audioElements.alert.src = silentAudio;
            audioElements.notification.src = silentAudio;
            audioElements.click.src = silentAudio;
        }

        // Play save sound
        function playSaveSound() {
            try {
                audioElements.save.currentTime = 0;
                audioElements.save.volume = AppState.settings.alertVolume / 100 * 0.3;
                audioElements.save.play().catch(e => {
                    console.log('Save sound play failed:', e);
                    // Try Web Audio API fallback
                    playSimpleTone(800, 0.3, 0.3);
                });
            } catch (e) {
                console.log('Save sound error:', e);
                playSimpleTone(800, 0.3, 0.3);
            }
        }

        // Play delete sound
        function playDeleteSound() {
            try {
                audioElements.delete.currentTime = 0;
                audioElements.delete.volume = AppState.settings.alertVolume / 100 * 0.3;
                audioElements.delete.play().catch(e => {
                    console.log('Delete sound play failed:', e);
                    playSimpleTone(400, 0.3, 0.3);
                });
            } catch (e) {
                console.log('Delete sound error:', e);
                playSimpleTone(400, 0.3, 0.3);
            }
        }

        // Play click sound
        function playClickSound() {
            try {
                audioElements.click.currentTime = 0;
                audioElements.click.volume = AppState.settings.alertVolume / 100 * 0.2;
                audioElements.click.play().catch(e => {
                    console.log('Click sound play failed:', e);
                    playSimpleTone(200, 0.1, 0.05);
                });
            } catch (e) {
                console.log('Click sound error:', e);
                playSimpleTone(200, 0.1, 0.05);
            }
        }

        // Play simple tone using Web Audio API
        function playSimpleTone(frequency, volume, duration) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                const adjustedVolume = volume * (AppState.settings.alertVolume / 100);
                gainNode.gain.setValueAtTime(adjustedVolume, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('Simple tone also failed:', e);
            }
        }

        // ======================
        // CUSTOM SOUND UPLOAD
        // ======================

        // Handle custom sound upload
        function handleCustomSoundUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validTypes = ['audio/mp3', 'audio/wav', 'audio/ogg', 'audio/mpeg'];
            if (!validTypes.includes(file.type)) {
                showToast('Invalid file type. Please upload MP3, WAV, or OGG files.', 'error');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('File too large. Maximum size is 5MB.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Store the file data
                    AppState.customSound = {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        data: e.target.result
                    };
                    
                    // Create object URL for playback
                    if (AppState.customSoundURL) {
                        URL.revokeObjectURL(AppState.customSoundURL);
                    }
                    AppState.customSoundURL = URL.createObjectURL(file);
                    
                    // Update the custom audio element
                    audioElements.custom.src = AppState.customSoundURL;
                    audioElements.custom.load();
                    
                    // Update UI
                    updateCustomSoundPreview();
                    
                    // Enable custom sound
                    AppState.settings.useCustomSound = true;
                    
                    showToast('Custom sound uploaded successfully!', 'success');
                    playClickSound();
                    
                } catch (error) {
                    showToast('Error processing sound file: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showToast('Error reading file', 'error');
            };
            
            reader.readAsDataURL(file);
        }

        // Update custom sound preview
        function updateCustomSoundPreview() {
            if (!AppState.customSound || !elements.soundPreview) return;
            
            elements.soundFileName.textContent = AppState.customSound.name;
            elements.soundFileSize.textContent = formatFileSize(AppState.customSound.size);
            elements.soundPreview.style.display = 'flex';
        }

        // Remove custom sound
        function removeCustomSound() {
            if (AppState.customSoundURL) {
                URL.revokeObjectURL(AppState.customSoundURL);
            }
            
            AppState.customSound = null;
            AppState.customSoundURL = null;
            AppState.settings.useCustomSound = false;
            
            audioElements.custom.src = '';
            
            if (elements.soundPreview) {
                elements.soundPreview.style.display = 'none';
            }
            
            if (elements.customSoundInput) {
                elements.customSoundInput.value = '';
            }
            
            showToast('Custom sound removed', 'info');
            playClickSound();
        }

        // Test custom sound
        function testCustomSound() {
            if (!AppState.customSoundURL || !audioElements.custom.src) {
                showToast('No custom sound loaded', 'warning');
                return;
            }
            
            try {
                audioElements.custom.volume = AppState.settings.alertVolume / 100;
                audioElements.custom.currentTime = 0;
                audioElements.custom.play().then(() => {
                    showToast('Playing custom sound', 'info');
                }).catch(e => {
                    console.log('Custom sound play failed:', e);
                    showToast('Could not play custom sound', 'error');
                });
            } catch (e) {
                console.log('Error playing custom sound:', e);
                showToast('Error playing custom sound', 'error');
            }
        }

        // ======================
        // ALERT SETTINGS
        // ======================

        // Load alert settings
        function loadAlertSettings() {
            // Update toggle switches
            if (elements.immediateAlertToggle) elements.immediateAlertToggle.checked = AppState.settings.immediateAlert;
            if (elements.continuousAlertToggle) elements.continuousAlertToggle.checked = AppState.settings.continuousAlert;
            
            // Update volume
            if (elements.alertVolume) {
                elements.alertVolume.value = AppState.settings.alertVolume;
            }
            if (elements.volumeValue) {
                elements.volumeValue.textContent = `${AppState.settings.alertVolume}%`;
            }
            
            // Update frequency
            if (elements.alertFrequency) {
                elements.alertFrequency.value = AppState.settings.alertFrequency;
            }
            
            // Update thresholds
            if (elements.urgentThreshold) {
                elements.urgentThreshold.value = AppState.settings.urgentThreshold;
            }
            if (elements.urgentThresholdValue) {
                elements.urgentThresholdValue.textContent = AppState.settings.urgentThreshold;
            }
            if (elements.urgentDays) {
                elements.urgentDays.textContent = AppState.settings.urgentThreshold;
            }
            
            if (elements.warningThreshold) {
                elements.warningThreshold.value = AppState.settings.warningThreshold;
            }
            if (elements.warningThresholdValue) {
                elements.warningThresholdValue.textContent = AppState.settings.warningThreshold;
            }
            if (elements.warningDays) {
                elements.warningDays.textContent = AppState.settings.warningThreshold;
            }
            
            // Update custom sound preview if exists
            if (AppState.customSound && elements.soundPreview) {
                updateCustomSoundPreview();
            }
        }

        // Update alert setting
        function updateAlertSetting() {
            AppState.settings.immediateAlert = elements.immediateAlertToggle ? elements.immediateAlertToggle.checked : true;
            AppState.settings.continuousAlert = elements.continuousAlertToggle ? elements.continuousAlertToggle.checked : true;
            AppState.settings.alertFrequency = elements.alertFrequency ? elements.alertFrequency.value : '5min';
        }

        // Update alert volume
        function updateAlertVolume(volume) {
            AppState.settings.alertVolume = volume;
            
            // Update all audio volumes
            try {
                const vol = volume / 100;
                audioElements.save.volume = vol * 0.3;
                audioElements.delete.volume = vol * 0.3;
                audioElements.alert.volume = vol * 0.5;
                audioElements.notification.volume = vol * 0.4;
                audioElements.click.volume = vol * 0.2;
                audioElements.custom.volume = vol * 0.5;
            } catch (e) {
                console.log('Volume update error:', e);
            }
        }

        // Save alert settings
        function saveAlertSettings() {
            saveToLocalStorage();
            showToast('Alert settings saved successfully', 'success');
            playSaveSound();
        }

        // ======================
        // LOCAL STORAGE MANAGEMENT
        // ======================

        // Save to localStorage
        function saveToLocalStorage() {
            try {
                const saveData = {
                    products: AppState.products,
                    barcodeMappings: AppState.barcodeMappings,
                    settings: AppState.settings,
                    notes: AppState.notes,
                    customSound: AppState.customSound,
                    systemLaunched: true,
                    lastSave: new Date().toISOString(),
                    version: '4.3' // Updated version for Base64 support
                };
                
                localStorage.setItem('expiryTrackerData', JSON.stringify(saveData));
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                showToast('Error saving data: Storage might be full', 'error');
            }
        }

        // Load from localStorage
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('expiryTrackerData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    if (data.products) {
                        AppState.products = data.products;
                        
                        // Update days left for all products
                        AppState.products.forEach(product => {
                            product.daysLeft = calculateDaysLeft(product.expiryDate);
                        });
                    }
                    
                    // Load barcode mappings
                    if (data.barcodeMappings) {
                        AppState.barcodeMappings = data.barcodeMappings;
                        if (Object.keys(AppState.barcodeMappings).length > 0) {
                            updateJsonPreviewAfterImport(AppState.barcodeMappings);
                        }
                    }
                    
                    if (data.settings) {
                        AppState.settings = { ...AppState.settings, ...data.settings };
                    }
                    
                    if (data.notes) {
                        AppState.notes = data.notes;
                    }
                    
                    // Load custom sound if available
                    if (data.customSound) {
                        AppState.customSound = data.customSound;
                        
                        // Recreate object URL from base64 data
                        if (AppState.customSound.data) {
                            const byteCharacters = atob(AppState.customSound.data.split(',')[1]);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], { type: AppState.customSound.type });
                            AppState.customSoundURL = URL.createObjectURL(blob);
                            audioElements.custom.src = AppState.customSoundURL;
                            audioElements.custom.load();
                        }
                    }
                    
                    // Update all displays
                    updateAllDisplays();
                }
            } catch (e) {
                console.error('Error loading from localStorage:', e);
            }
        }

        // ======================
        // KEYBOARD SHORTCUTS
        // ======================

        // Handle keyboard shortcuts
        function handleKeyboardShortcuts(e) {
            // Don't trigger if user is typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }
            
            // Ctrl/Cmd + S - Save product
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (AppState.currentSection === 'add') {
                    const submitBtn = document.querySelector('#addProductForm button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.click();
                    }
                }
                showToast('Saved (Ctrl+S)', 'info');
            }
            
            // Ctrl/Cmd + E - Export data
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                exportData();
            }
            
            // Ctrl/Cmd + I - Import data
            if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                e.preventDefault();
                const importInput = document.getElementById('importFileInput');
                if (importInput) {
                    importInput.click();
                }
            }
            
            // Number keys 1-6 - Navigate sections
            if (e.key >= '1' && e.key <= '6') {
                e.preventDefault();
                const sections = ['expiring', 'expired', 'add', 'all', 'alerts', 'instructions'];
                const index = parseInt(e.key) - 1;
                if (sections[index]) {
                    switchSection(sections[index]);
                }
            }
            
            // Q - Quick add
            if (e.key === 'q' || e.key === 'Q') {
                e.preventDefault();
                switchSection('add');
                playClickSound();
            }
            
            // P - Print
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                printData();
            }
            
            // F - Focus search
            if (e.key === 'f' || e.key === 'F') {
                e.preventDefault();
                if (AppState.currentSection === 'all' && elements.searchProducts) {
                    elements.searchProducts.focus();
                }
            }
            
            // ESC - Close modals
            if (e.key === 'Escape') {
                if (elements.deleteModal && elements.deleteModal.classList.contains('active')) {
                    hideDeleteModal();
                }
                
                if (elements.productDetailsModal && elements.productDetailsModal.classList.contains('active')) {
                    hideProductDetailsModal();
                }
            }
            
            // A - Acknowledge alerts
            if (e.key === 'a' || e.key === 'A') {
                if (elements.soundAlertIndicator && elements.soundAlertIndicator.classList.contains('active')) {
                    e.preventDefault();
                    acknowledgeAlerts();
                }
            }
        }

        // Update footer stats
        function updateFooterStats() {
            const total = AppState.products.length;
            const urgent = AppState.products.filter(p => p.daysLeft >= 0 && p.daysLeft <= AppState.settings.urgentThreshold).length;
            const expiring = AppState.products.filter(p => p.daysLeft >= 0 && p.daysLeft <= 10).length;
            
            const footerTotalItems = document.getElementById('footerTotalItems');
            const footerUrgentItems = document.getElementById('footerUrgentItems');
            const footerExpiringItems = document.getElementById('footerExpiringItems');
            
            if (footerTotalItems) footerTotalItems.textContent = total;
            if (footerUrgentItems) footerUrgentItems.textContent = urgent;
            if (footerExpiringItems) footerExpiringItems.textContent = expiring;
        }

        // Final initialization
        console.log(`
╔══════════════════════════════════════════════════════════════╗
║                                                              ║
║   ✨ SMART EXPIRY TRACKER PRO v4.3 - ENHANCED ✨             ║
║                                                              ║
║   ✅ ENHANCED FILE UPLOAD SUPPORT:                           ║
║   • Supports both JSON and Base64-encoded JSON files        ║
║   • Automatic detection of file type                        ║
║   • Decodes Base64 internally for full functionality        ║
║   • Files can't be read easily by humans if Base64 encoded  ║
║   • All existing features 100% working                      ║
║   • Sound System: 100% RELIABLE                             ║
║                                                              ║
║   JSON/Base64 Barcode Mapping Upload - ENHANCED VERSION     ║
║   1. Upload JSON file → works directly                      ║
║   2. Upload Base64 JSON → auto-decodes and works            ║
║   3. Auto-fills description when barcode is entered         ║
║   4. Error-safe JSON parsing with validation                ║
║   5. Clear success/error messages for both formats          ║
║   6. Large files supported (30,000+ barcodes)               ║
║   7. Works 100% offline                                     ║
║                                                              ║
║   Creator: Shandana 💔 Nasrullah                            ║
║   "I live through you; if I fall, your soul falls with me"  ║
║                                                              ║
╚══════════════════════════════════════════════════════════════╝
`);

        // Auto-save every minute
        setInterval(saveToLocalStorage, 60000);

        // Update display every 30 seconds to refresh days left
        setInterval(() => {
            AppState.products.forEach(product => {
                product.daysLeft = calculateDaysLeft(product.expiryDate);
            });
            updateAllDisplays();
        }, 30000);

        // Reset acknowledged alerts every day
        setInterval(() => {
            AppState.acknowledgedAlerts = false;
            checkForUrgentItems();
        }, 24 * 60 * 60 * 1000);

        // Initialize the system fully
        setTimeout(() => {
            if (elements.mainContainer.style.display !== 'none') {
                checkForUrgentItems();
                updateAllDisplays();
                loadAlertSettings();
            }
        }, 2000);
    </script>
</body>
</html>